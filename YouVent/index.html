<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유벤트 (YouVent) - 모든 유튜브 이벤트를 한눈에!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .form-checkbox:checked { background-color: #2563eb; border-color: #2563eb; }
        .page, .modal-overlay { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .hidden { display: none; }
        .modal-overlay.hidden { visibility: hidden; opacity: 0; }
        .modal-overlay { visibility: visible; opacity: 1; }
        .pagination-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .nav-link.active { color: #2563eb; font-weight: 700; border-bottom: 2px solid #2563eb; }
        .sub-filter-btn.active { background-color: #3B82F6; color: white; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header Section -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-blue-600 cursor-pointer" onclick="showListPage('ongoing', 'all')">You<span class="text-orange-500">Vent</span></div>
            <div id="main-nav" class="hidden md:flex items-center space-x-8">
                <a href="#" id="nav-ongoing" class="nav-link pb-1" onclick="showListPage('ongoing', 'all'); return false;">진행중인 이벤트</a>
                <a href="#" id="nav-ended" class="nav-link pb-1" onclick="showListPage('ended'); return false;">종료된 이벤트</a>
                <a href="#" class="nav-link pb-1" onclick="openModal('report-modal')">이벤트 제보</a>
            </div>
            <div id="auth-section">
                 <button onclick="openModal('login-modal')" class="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow hover:bg-blue-700">로그인</button>
            </div>
        </nav>
    </header>

    <main id="list-page" class="page container mx-auto px-6 py-8">
        <!-- Notice for 'Ended Events' -->
        <div id="ended-events-notice" class="hidden mb-4 p-4 bg-blue-100 text-blue-800 rounded-lg text-sm text-center">
            종료일로부터 2주가 지난 게시글은 자동으로 목록에서 사라집니다.
        </div>

        <!-- Sub-filters for 'Ongoing Events' -->
        <div id="sub-filter-container" class="mb-6 flex space-x-2 flex-wrap gap-y-2">
            <button id="sub-filter-all" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('all')">전체</button>
            <button id="sub-filter-youtube" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('youtube')">유튜브 및 SNS</button>
            <button id="sub-filter-discount" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('discount')">할인이벤트</button>
            <button id="sub-filter-airdrop" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('airdrop')">에어드랍</button>
            <button id="sub-filter-other" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('other')">기타</button>
        </div>

        <div id="list-header" class="hidden md:flex bg-white rounded-t-lg px-6 py-3 text-sm font-bold text-gray-600 border-b items-center">
            <!-- List header content will be set by JS -->
        </div>
        <div id="eventList" class="bg-white rounded-b-lg shadow-sm"></div>
        <div id="pagination" class="mt-6 flex justify-center items-center space-x-2"></div>
    </main>

    <main id="detail-page" class="page hidden container mx-auto px-6 py-8"></main>
    <main id="admin-dashboard-page" class="page hidden container mx-auto px-6 py-8"></main>
    <div id="login-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="report-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="register-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>


    <script type="module">
        // 1. Firebase SDK 모듈 가져오기 (Auth 추가)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, query, where, orderBy, limit, startAfter, getDoc, setDoc, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
        
        // 2. 본인의 Firebase 프로젝트 설정 정보로 교체
        const firebaseConfig = {
            apiKey: "AIzaSyD5xVbWnUE4gF9PUdXoqUZ62U7YDwiSu0s",
            authDomain: "youvent-3cb0d.firebaseapp.com",
            projectId: "youvent-3cb0d",
            storageBucket: "youvent-3cb0d.appspot.com",
            messagingSenderId: "647513816009",
            appId: "1:647513816009:web:0638bbd49496e1514f4618",
            measurementId: "G-BKNFPCY4NS"
        };

        // 3. Firebase 서비스 초기화 (Auth 추가)
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const eventsCollection = collection(db, "events");

        // --- 전역 변수 및 상태 ---
        let currentUser = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let mainFilter = 'ongoing'; // 'ongoing' or 'ended'
        let subFilter = 'all'; // 'all', 'youtube', 'discount', 'airdrop', 'other'
        
        // --- DOM Elements ---
        const listPage = document.getElementById('list-page'), detailPage = document.getElementById('detail-page'), adminDashboardPage = document.getElementById('admin-dashboard-page');
        const eventList = document.getElementById('eventList'), paginationContainer = document.getElementById('pagination');
        const listHeader = document.getElementById('list-header'), subFilterContainer = document.getElementById('sub-filter-container');
        const endedEventsNotice = document.getElementById('ended-events-notice');

        // --- 로직 함수 ---
        window.getEventStatus = function(endDateStr) {
            const today = new Date();
            if (!endDateStr) return { status: '진행중', badge: '<span class="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full">진행중</span>', d_day_html: '' };
            
            const endDate = new Date(endDateStr + 'T23:59:59');
            const diffTime = endDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays >= 0) {
                return { status: '진행중', badge: '<span class="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full">진행중</span>', d_day_html: `<span class="text-orange-500 font-bold text-lg">${`D-${diffDays}`}</span>` };
            } else {
                return { status: '종료', badge: '<span class="bg-gray-200 text-gray-600 text-xs font-bold px-3 py-1 rounded-full">종료</span>', d_day_html: `<span class="text-gray-400 font-bold">종료</span>` };
            }
        }
        
        // --- UI 렌더링 함수 ---
        
        function updateActiveNav() {
            document.getElementById('nav-ongoing').classList.toggle('active', mainFilter === 'ongoing');
            document.getElementById('nav-ended').classList.toggle('active', mainFilter === 'ended');

            subFilterContainer.classList.toggle('hidden', mainFilter !== 'ongoing');
            endedEventsNotice.classList.toggle('hidden', mainFilter !== 'ended');

            if (mainFilter === 'ongoing') {
                document.querySelectorAll('.sub-filter-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`sub-filter-${subFilter}`).classList.add('active');
            }
        }

        function setListHeader() {
            if (subFilter === 'discount' && mainFilter === 'ongoing') {
                listHeader.innerHTML = `
                    <div class="w-1/5 text-center">상태</div>
                    <div class="w-2/5">상품/내용</div>
                    <div class="w-1/5">판매처</div>
                    <div class="w-1/5 text-center">바로가기</div>`;
            } else {
                listHeader.innerHTML = `
                    <div class="w-[10%] text-center">D-Day</div>
                    <div class="w-[10%] text-center">상태</div>
                    <div class="w-[40%]">상품</div>
                    <div class="w-[20%]">채널명</div>
                    <div class="w-[10%]">마감일</div>
                    <div class="w-[10%] text-center">참여 여부</div>`;
            }
        }

        async function renderEventList() {
            eventList.innerHTML = `<div class="text-center p-10 text-gray-500">이벤트 목록을 불러오는 중...</div>`;
            setListHeader();
            
            try {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                let queryConstraints = [];

                if (mainFilter === 'ongoing') {
                    queryConstraints.push(where("endDate", ">=", todayStr));
                } else {
                    const twoWeeksAgo = new Date(new Date().setDate(today.getDate() - 14));
                    const twoWeeksAgoStr = twoWeeksAgo.toISOString().split('T')[0];
                    queryConstraints.push(where("endDate", "<", todayStr));
                    queryConstraints.push(where("endDate", ">=", twoWeeksAgoStr));
                }

                if (mainFilter === 'ongoing' && subFilter !== 'all') {
                    queryConstraints.push(where("type", "==", subFilter));
                }

                queryConstraints.push(orderBy("endDate", "desc"));

                const q = query(eventsCollection, ...queryConstraints);
                const querySnapshot = await getDocs(q);

                const eventsData = [];
                querySnapshot.forEach((doc) => {
                    eventsData.push({ id: doc.id, ...doc.data() });
                });
                
                eventList.innerHTML = '';
                if (eventsData.length === 0) {
                    eventList.innerHTML = `<div class="text-center p-10 text-gray-500">표시할 이벤트가 없습니다.</div>`;
                } else {
                    const listItemsHtml = await Promise.all(eventsData.map(async (event) => {
                        const { badge, d_day_html } = getEventStatus(event.endDate);
                        
                        if (event.type === 'discount') {
                            return `
                                <div class="border-b last:border-b-0">
                                    <div class="hidden md:flex w-full items-center px-6 py-4 hover:bg-gray-50">
                                        <div class="w-1/5 text-center">${badge}</div>
                                        <div class="w-2/5 font-bold truncate">${event.prize}</div>
                                        <div class="w-1/5 text-gray-600 truncate">${event.channelName}</div>
                                        <div class="w-1/5 text-center">
                                            <a href="${event.linkUrl}" target="_blank" class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-600">보러가기</a>
                                        </div>
                                    </div>
                                    <a href="${event.linkUrl}" target="_blank" class="block md:hidden p-4">
                                        <div class="flex justify-between items-center mb-2"><p class="font-bold w-4/5">${event.prize}</p>${badge}</div>
                                        <p class="text-sm text-gray-600">${event.channelName}</p>
                                    </a>
                                </div>`;
                        } else { // 'youtube', 'airdrop', 'other'
                            let participated = false;
                            if (currentUser) {
                                const participationRef = doc(db, "events", event.id, "participants", currentUser.uid);
                                const participationSnap = await getDoc(participationRef);
                                participated = participationSnap.exists();
                            }
                            const participationCheckbox = `<input type="checkbox" onclick="toggleParticipation('${event.id}')" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300" ${participated ? 'checked' : ''}>`;
                            return `
                                <div class="border-b last:border-b-0">
                                    <div class="hidden md:flex w-full items-center px-6 py-4 hover:bg-gray-50">
                                        <div class="w-[10%] text-center">${d_day_html}</div>
                                        <div class="w-[10%] text-center">${badge}</div>
                                        <div class="w-[40%] pr-4"><p class="font-bold truncate cursor-pointer" onclick="showDetailPage('${event.id}')">${event.prize}</p></div>
                                        <div class="w-[20%] truncate">${event.channelName}</div>
                                        <div class="w-[10%]">${event.endDate.replace(/-/g, '.')}</div>
                                        <div class="w-[10%] text-center">${currentUser ? participationCheckbox : ''}</div>
                                    </div>
                                    <div class="w-full md:hidden p-4 cursor-pointer" onclick="showDetailPage('${event.id}')">
                                        <div class="flex justify-between items-start mb-2"><p class="font-bold w-4/5">${event.prize}</p>${d_day_html}</div>
                                        <p class="text-sm text-gray-600 mb-3">${event.channelName}</p>
                                        <div class="flex justify-between items-center text-sm">${badge}<span class="ml-3">마감: ${event.endDate.replace(/-/g, '.')}</span></div>
                                    </div>
                                </div>`;
                        }
                    }));
                    eventList.innerHTML = listItemsHtml.join('');
                }
                paginationContainer.innerHTML = '';

            } catch (error) {
                console.error("이벤트 목록 불러오기 오류: ", error);
                eventList.innerHTML = `<div class="text-center p-10 text-red-500">목록을 불러오는데 실패했습니다.</div>`;
            }
        }
        
        // --- 페이지 전환 및 모달 함수 ---
        function showPage(pageId) {
            [listPage, detailPage, adminDashboardPage].forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        window.showListPage = function(newMainFilter, newSubFilter = 'all') {
            mainFilter = newMainFilter;
            subFilter = newSubFilter;
            updateActiveNav();
            showPage('list-page');
            renderEventList();
        }
        
        window.setSubFilter = function(newSubFilter) {
            subFilter = newSubFilter;
            updateActiveNav();
            renderEventList();
        }
        
        // --- 초기화 ---
        window.onload = () => {
            // 이전에 생략되었던 함수들의 전체 구현부를 여기에 포함합니다.
            window.toggleParticipation = async function(id) {
                if (!currentUser) { alert("로그인이 필요한 기능입니다."); openModal('login-modal'); return; }
                const userId = currentUser.uid;
                const eventRef = doc(db, "events", id);
                const participationRef = doc(db, "events", id, "participants", userId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const eventDoc = await transaction.get(eventRef);
                        if (!eventDoc.exists()) { throw "Event does not exist!"; }
                        const participationDoc = await transaction.get(participationRef);
                        let newParticipantsCount = eventDoc.data().participants || 0;
                        if (participationDoc.exists()) {
                            transaction.delete(participationRef);
                            newParticipantsCount--;
                        } else {
                            transaction.set(participationRef, { participatedAt: serverTimestamp() });
                            newParticipantsCount++;
                        }
                        transaction.update(eventRef, { participants: newParticipantsCount < 0 ? 0 : newParticipantsCount });
                    });
                    if (!detailPage.classList.contains('hidden')) { showDetailPage(id); } else { renderEventList(); }
                } catch (error) { console.error("참여 상태 업데이트 오류: ", error); alert('상태 변경 중 오류가 발생했습니다.'); }
            };
            window.handleEventSubmit = async function(e) {
                e.preventDefault();
                const form = e.target;
                const eventType = form.eventType.value;
                const linkUrl = form.linkUrl.value;
                const q = query(eventsCollection, where("linkUrl", "==", linkUrl));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) { alert('이미 등록된 링크의 이벤트입니다.'); return; }
                const newEvent = { type: eventType, prize: form.prize.value, channelName: form.channelName.value, endDate: form.endDate.value || '9999-12-31', linkUrl: linkUrl, participants: 0, createdAt: serverTimestamp() };
                try { await addDoc(eventsCollection, newEvent); alert('이벤트가 성공적으로 등록되었습니다.'); closeModal('register-modal'); form.reset(); showListPage(eventType); } catch (error) { console.error("이벤트 등록 오류: ", error); alert('등록 중 오류가 발생했습니다.'); }
            };
            window.showDetailPage = async function(id) {
                const eventDocRef = doc(db, "events", id);
                try {
                    const docSnap = await getDoc(eventDocRef);
                    if (!docSnap.exists()) { detailPage.innerHTML = `<div class="text-center p-10 text-red-500">해당 이벤트를 찾을 수 없습니다.</div>`; showPage('detail-page'); return; }
                    const event = { id: docSnap.id, ...docSnap.data() };
                    const { badge, d_day_html } = getEventStatus(event.endDate);
                    let participated = false;
                    if (currentUser && event.type === 'youtube') { const participationRef = doc(db, "events", event.id, "participants", currentUser.uid); const participationSnap = await getDoc(participationRef); participated = participationSnap.exists(); }
                    let detailHTML = `<div class="bg-white p-8 rounded-lg shadow-lg"><button onclick="showListPage('${mainFilter}', '${subFilter}')" class="mb-6 text-blue-600 hover:underline">&larr; 목록으로 돌아가기</button><div class="flex flex-col md:flex-row justify-between items-start mb-4"><h1 class="text-3xl font-bold text-gray-900 mb-2 md:mb-0">${event.prize}</h1><div class="flex items-center space-x-3">${badge} ${d_day_html}</div></div><p class="text-lg text-gray-600 mb-6">주최/판매처: ${event.channelName}</p><div class="border-y py-6 mb-6"><h2 class="text-xl font-semibold mb-3">상세 정보</h2><p class="mb-4">여기에 이벤트 참여 방법, 상세 규칙 등 상세 내용이 표시됩니다.</p><a href="${event.linkUrl}" target="_blank" class="inline-block bg-red-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-red-700">링크 바로가기 &rarr;</a></div>`;
                    if (event.type === 'youtube' || event.type === 'airdrop' || event.type === 'other') { detailHTML += `<div class="flex justify-between items-center"><div class="flex items-center space-x-3"><button onclick="toggleParticipation('${event.id}')" class="font-semibold px-6 py-3 rounded-lg ${participated ? 'bg-gray-200 text-gray-800' : 'bg-blue-600 text-white'}">${participated ? '✔️ 참여 취소' : '👍 참여하기'}</button><div class="text-gray-500"><span class="font-bold">${event.participants.toLocaleString()}</span>명이 참여중</div></div><div class="text-right"><p class="font-semibold">마감일</p><p>${event.endDate.replace(/-/g, '.')}</div></div>`; }
                    detailHTML += `</div>`;
                    detailPage.innerHTML = detailHTML;
                    showPage('detail-page');
                } catch (error) { console.error("상세 페이지 로딩 오류: ", error); detailPage.innerHTML = `<div class="text-center p-10 text-red-500">상세 정보를 불러오는 데 실패했습니다.</div>`; }
            };
            window.openModal = function(modalId, data = {}) { const modal = document.getElementById(modalId); if (modalId === 'register-modal' && data.linkUrl) { const form = modal.querySelector('form'); if (form) form.linkUrl.value = data.linkUrl; } modal.classList.remove('hidden'); };
            window.closeModal = function(modalId) { document.getElementById(modalId).classList.add('hidden'); };
            renderModals = function() { 
                document.getElementById('login-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm"><h2 class="text-2xl font-bold text-center mb-6">로그인</h2><div class="space-y-4"><button onclick="login()" class="w-full flex items-center justify-center bg-white border border-gray-300 py-3 rounded-lg"><img src="https://www.google.com/favicon.ico" class="w-5 h-5 mr-3"> Google 계정으로 로그인</button></div><button onclick="closeModal('login-modal')" class="mt-6 w-full text-center text-gray-500">닫기</button></div>`; 
                document.getElementById('report-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">이벤트 제보하기</h2><form onsubmit="alert('제보가 접수되었습니다.'); closeModal('report-modal'); this.reset(); return false;"><div class="space-y-4"><input type="url" placeholder="이벤트 링크" required class="w-full p-3 border rounded-lg"><textarea placeholder="이벤트 내용 요약" required class="w-full p-3 border rounded-lg h-24"></textarea></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('report-modal')" class="px-6 py-2 bg-gray-200 rounded-lg">취소</button><button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg">제출</button></div></form></div>`; 
                document.getElementById('register-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">새 이벤트 등록</h2><form onsubmit="handleEventSubmit(event)"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">이벤트 종류</label><select name="eventType" class="w-full p-3 border rounded-lg"><option value="youtube">유튜브(SNS)</option><option value="discount">할인이벤트</option><option value="airdrop">에어드랍</option><option value="other">기타</option></select></div><input type="text" name="prize" placeholder="상품명/내용" required class="w-full p-3 border rounded-lg"><input type="text" name="channelName" placeholder="채널명/판매처" required class="w-full p-3 border rounded-lg"><input type="url" name="linkUrl" placeholder="이벤트 링크" required class="w-full p-3 border rounded-lg"><input type="date" name="endDate" class="w-full p-3 border rounded-lg"></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('register-modal')" class="px-6 py-2 bg-gray-200 rounded-lg">취소</button><button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg">등록</button></div></form></div>`; 
            };
            updateUIForAuthState = function(user) {
                currentUser = user;
                const isAdmin = currentUser && currentUser.email === "YOUR_ADMIN_EMAIL@gmail.com";
                if (currentUser) { authSection.innerHTML = `<div class="flex items-center"><span class="font-semibold mr-4">${currentUser.displayName}님</span><button onclick="logout()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm font-semibold hover:bg-gray-300">로그아웃</button></div>`; } else { authSection.innerHTML = `<button onclick="openModal('login-modal')" class="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow hover:bg-blue-700">로그인</button>`; }
                const adminNavLink = document.getElementById('admin-nav-link');
                if (isAdmin && !adminNavLink) { const link = document.createElement('a'); link.id = 'admin-nav-link'; link.href = '#'; link.className = 'nav-link pb-1 text-red-500 font-bold'; link.innerText = '관리자'; link.onclick = () => showAdminDashboard(); mainNav.appendChild(link); } else if (!isAdmin && adminNavLink) { adminNavLink.remove(); }
            };
            window.login = async function() { const provider = new GoogleAuthProvider(); try { await signInWithPopup(auth, provider); closeModal('login-modal'); } catch (error) { console.error("Google 로그인 오류:", error); alert("로그인 중 오류가 발생했습니다."); } };
            window.logout = async function() { try { await signOut(auth); } catch (error) { console.error("로그아웃 오류:", error); } };
            
            renderModals();
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                updateUIForAuthState(user);
                showListPage(mainFilter, subFilter);
            });
        };
    </script>
</body>
</html>
