<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유벤트 (YouVent) - 모든 유튜브 이벤트를 한눈에!</title>
    <meta name="description" content="유튜브, SNS, 쇼핑몰 등 모든 종류의 이벤트를 모아서 보여주는 유벤트입니다.">
    <meta name="keywords" content="유튜브, 이벤트, 구독, 댓글, 경품, 할인, 에어드랍">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎁</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .form-checkbox:checked { background-color: #2563eb; border-color: #2563eb; }
        .page, .modal-overlay { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .hidden { display: none; }
        .modal-overlay.hidden { visibility: hidden; opacity: 0; }
        .modal-overlay { visibility: visible; opacity: 1; }
        .pagination-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .nav-link.active { color: #2563eb; font-weight: 700; border-bottom: 2px solid #2563eb; }
        .sub-filter-btn.active { background-color: #3B82F6; color: white; }
        .terms-content { height: 12rem; overflow-y: scroll; border: 1px solid #e5e7eb; padding: 0.75rem; font-size: 0.875rem; color: #4b5563; background-color: #f9fafb; border-radius: 0.5rem;}
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <!-- Header Section -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-blue-600 cursor-pointer" onclick="showListPage('ongoing', 'all')">You<span class="text-orange-500">Vent</span></div>
            <div id="main-nav" class="hidden md:flex items-center space-x-8">
                <a href="#" id="nav-ongoing" class="nav-link pb-1" onclick="showListPage('ongoing', 'all'); return false;">진행중인 이벤트</a>
                <a href="#" id="nav-ended" class="nav-link pb-1" onclick="showListPage('ended'); return false;">종료된 이벤트</a>
                <a href="#" class="nav-link pb-1" onclick="openModal('report-modal')">이벤트 제보</a>
            </div>
            <div class="flex items-center">
                <div id="auth-section" class="hidden md:block mr-4">
                     <button onclick="openModal('login-modal')" class="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow hover:bg-blue-700">로그인</button>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-500 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <!-- Mobile nav links will be populated by JS -->
        </div>
    </header>

    <div class="flex-grow">
        <main id="list-page" class="page container mx-auto px-6 py-8">
            <div id="ended-events-notice" class="hidden mb-4 p-4 bg-blue-100 text-blue-800 rounded-lg text-sm text-center">
                종료일로부터 2주가 지난 게시글은 자동으로 목록에서 사라집니다.
            </div>
            <div id="sub-filter-container" class="mb-6 flex space-x-2 flex-wrap gap-y-2">
                <button id="sub-filter-all" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('all')">전체</button>
                <button id="sub-filter-youtube" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('youtube')">유튜브 및 SNS</button>
                <button id="sub-filter-discount" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('discount')">할인이벤트</button>
                <button id="sub-filter-airdrop" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('airdrop')">에어드랍</button>
                <button id="sub-filter-other" class="sub-filter-btn px-4 py-2 rounded-full text-sm font-semibold border" onclick="setSubFilter('other')">기타</button>
            </div>
            <div id="list-header" class="hidden md:flex bg-white rounded-t-lg px-6 py-3 text-sm font-bold text-gray-600 border-b items-center"></div>
            <div id="eventList" class="bg-white rounded-b-lg shadow-sm"></div>
            <div id="pagination" class="mt-6 flex justify-center items-center space-x-2"></div>
        </main>

        <main id="detail-page" class="page hidden container mx-auto px-6 py-8"></main>
        
        <main id="admin-dashboard-page" class="page hidden container mx-auto px-6 py-8">
            <h1 class="text-3xl font-bold mb-8">관리자 대시보드</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">이벤트 관리</h2>
                    <button onclick="openModal('register-modal')" class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">+ 새 이벤트 등록하기</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">접수된 제보 목록</h2>
                    <div id="reportList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white mt-12">
        <div class="container mx-auto px-6 py-4 text-xs">
            <div class="flex flex-col md:flex-row justify-between items-center gap-2 text-center md:text-left">
                <p class="order-3 md:order-1">&copy; 2025 YouVent. All Rights Reserved.</p>
                <div class="order-2 md:order-2 flex space-x-4">
                    <a href="#" onclick="openModal('terms-of-service-modal'); return false;" class="hover:text-white">이용약관</a>
                    <a href="#" onclick="openModal('privacy-policy-modal'); return false;" class="hover:text-white">개인정보처리방침</a>
                </div>
                <p class="order-1 md:order-3">운영자 문의: parkgi1100@gmail.com</p>
            </div>
        </div>
    </footer>

    <div id="login-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="report-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="register-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="terms-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="logout-options-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="delete-account-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="terms-of-service-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>
    <div id="privacy-policy-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, query, where, orderBy, getDoc, setDoc, serverTimestamp, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD5xVbWnUE4gF9PUdXoqUZ62U7YDwiSu0s",
            authDomain: "youvent-3cb0d.firebaseapp.com",
            projectId: "youvent-3cb0d",
            storageBucket: "youvent-3cb0d.appspot.com",
            messagingSenderId: "647513816009",
            appId: "1:647513816009:web:0638bbd49496e1514f4618",
            measurementId: "G-BKNFPCY4NS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const eventsCollection = collection(db, "events");
        const usersCollection = collection(db, "users");
        const reportsCollection = collection(db, "reports");

        let currentUser = null;
        let currentUserInfo = null;
        let mainFilter = 'ongoing';
        let subFilter = 'all';
        
        const listPage = document.getElementById('list-page'), detailPage = document.getElementById('detail-page'), adminDashboardPage = document.getElementById('admin-dashboard-page');
        const eventList = document.getElementById('eventList'), paginationContainer = document.getElementById('pagination');
        const listHeader = document.getElementById('list-header'), subFilterContainer = document.getElementById('sub-filter-container');
        const endedEventsNotice = document.getElementById('ended-events-notice');
        const authSection = document.getElementById('auth-section');
        const mainNav = document.getElementById('main-nav');
        const reportList = document.getElementById('reportList');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        // --- 로직 함수 ---
        const getEventStatus = (endDateStr) => {
            const today = new Date();
            if (!endDateStr) return { status: '진행중', badge: '<span class="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full">진행중</span>', d_day_html: '' };
            const endDate = new Date(endDateStr + 'T23:59:59');
            const diffTime = endDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays >= 0) {
                return { status: '진행중', badge: '<span class="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full">진행중</span>', d_day_html: `<span class="text-orange-500 font-bold text-lg">${`D-${diffDays}`}</span>` };
            } else {
                return { status: '종료', badge: '<span class="bg-gray-200 text-gray-600 text-xs font-bold px-3 py-1 rounded-full">종료</span>', d_day_html: `<span class="text-gray-400 font-bold">종료</span>` };
            }
        };

        const handleParticipation = async (eventId, newStatus) => {
            if (!currentUser) { alert("로그인이 필요한 기능입니다."); openModal('login-modal'); return; }
            const userId = currentUser.uid;
            const eventRef = doc(db, "events", eventId);
            const participationRef = doc(db, "events", eventId, "participants", userId);
            try {
                await runTransaction(db, async (transaction) => {
                    const eventDoc = await transaction.get(eventRef);
                    if (!eventDoc.exists()) throw "Event does not exist!";
                    
                    const participationDoc = await transaction.get(participationRef);
                    const oldStatus = participationDoc.exists() ? participationDoc.data().status : null;

                    let participatedCount = eventDoc.data().participatedCount || 0;
                    let notInterestedCount = eventDoc.data().notInterestedCount || 0;

                    if (oldStatus === newStatus) {
                        transaction.delete(participationRef);
                        if (newStatus === 'participated') participatedCount--;
                        if (newStatus === 'not_interested') notInterestedCount--;
                    } else {
                        if (oldStatus === 'participated') participatedCount--;
                        if (oldStatus === 'not_interested') notInterestedCount--;
                        
                        if (newStatus === 'participated') participatedCount++;
                        if (newStatus === 'not_interested') notInterestedCount++;
                        
                        transaction.set(participationRef, { status: newStatus, updatedAt: serverTimestamp() });
                    }
                    
                    transaction.update(eventRef, { 
                        participatedCount: participatedCount < 0 ? 0 : participatedCount,
                        notInterestedCount: notInterestedCount < 0 ? 0 : notInterestedCount
                    });
                });
                if (!detailPage.classList.contains('hidden')) { showDetailPage(eventId); } else { renderEventList(); }
            } catch (error) { console.error("참여 상태 업데이트 오류: ", error); alert('상태 변경 중 오류가 발생했습니다.'); }
        };

        const handleEventSubmit = async (e) => {
            e.preventDefault();
            if (!currentUserInfo || !['admin', 'sub-admin'].includes(currentUserInfo.role)) {
                alert('이벤트 등록 권한이 없습니다.');
                return;
            }
            const form = e.target;
            const eventType = form.eventType.value;
            const linkUrl = form.linkUrl.value;
            const description = form.description.value;
            
            try { new URL(linkUrl); } catch (_) { alert('올바른 형식의 링크 주소를 입력해주세요. (예: https://...)'); return; }

            const q = query(eventsCollection, where("linkUrl", "==", linkUrl));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) { alert('이미 등록된 링크의 이벤트입니다.'); return; }
            const newEvent = { type: eventType, prize: form.prize.value, channelName: form.channelName.value, endDate: form.endDate.value || '9999-12-31', linkUrl: linkUrl, description: description, participatedCount: 0, notInterestedCount: 0, createdAt: serverTimestamp() };
            try { await addDoc(eventsCollection, newEvent); alert('이벤트가 성공적으로 등록되었습니다.'); closeModal('register-modal'); form.reset(); showListPage(eventType); } catch (error) { console.error("이벤트 등록 오류: ", error); alert('등록 중 오류가 발생했습니다.'); }
        };

        const handleReportSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const newReport = {
                linkUrl: form.linkUrl.value,
                summary: form.summary.value,
                status: 'pending',
                createdAt: serverTimestamp(),
                reporter: currentUser ? currentUser.email : '비회원'
            };
            try {
                await addDoc(reportsCollection, newReport);
                alert('제보가 정상적으로 접수되었습니다. 감사합니다.');
                closeModal('report-modal');
                form.reset();
            } catch (error) {
                console.error("제보 등록 오류: ", error);
                alert("제보 처리 중 오류가 발생했습니다.");
            }
        };
        
        // --- UI 렌더링 함수 ---
        
        const updateActiveNav = () => {
            document.getElementById('nav-ongoing').classList.toggle('active', mainFilter === 'ongoing');
            document.getElementById('nav-ended').classList.toggle('active', mainFilter === 'ended');
            subFilterContainer.classList.toggle('hidden', mainFilter !== 'ongoing');
            endedEventsNotice.classList.toggle('hidden', mainFilter !== 'ended');
            if (mainFilter === 'ongoing') {
                document.querySelectorAll('.sub-filter-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`sub-filter-${subFilter}`).classList.add('active');
            }
        }

        const setListHeader = () => {
            const isAdmin = currentUserInfo && ['admin', 'sub-admin'].includes(currentUserInfo.role);
            const adminHeader = isAdmin ? `<div class="w-[10%]"></div>` : '';

            if (subFilter === 'discount' && mainFilter === 'ongoing') {
                listHeader.innerHTML = `<div class="w-1/5 text-center">상태</div><div class="w-2/5">상품/내용</div><div class="w-1/5">판매처</div><div class="w-1/5 text-center">바로가기</div>${adminHeader}`;
            } else {
                listHeader.innerHTML = `<div class="w-[10%] text-center">D-Day</div><div class="w-[10%] text-center">상태</div><div class="w-[35%]">상품</div><div class="w-[20%]">채널명</div><div class="w-[10%]">마감일</div><div class="w-[10%] text-center">참여 여부</div>${adminHeader}`;
            }
        }

        const renderEventList = async () => {
            eventList.innerHTML = `<div class="text-center p-10 text-gray-500">이벤트 목록을 불러오는 중...</div>`;
            setListHeader();
            try {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                let queryConstraints = [];
                if (mainFilter === 'ongoing') {
                    queryConstraints.push(where("endDate", ">=", todayStr));
                } else {
                    const twoWeeksAgo = new Date(new Date().setDate(today.getDate() - 14));
                    const twoWeeksAgoStr = twoWeeksAgo.toISOString().split('T')[0];
                    queryConstraints.push(where("endDate", "<", todayStr), where("endDate", ">=", twoWeeksAgoStr));
                }
                if (mainFilter === 'ongoing' && subFilter !== 'all') {
                    queryConstraints.push(where("type", "==", subFilter));
                }
                queryConstraints.push(orderBy("endDate", "desc"));
                const q = query(eventsCollection, ...queryConstraints);
                const querySnapshot = await getDocs(q);
                const eventsData = [];
                querySnapshot.forEach((doc) => { eventsData.push({ id: doc.id, ...doc.data() }); });
                eventList.innerHTML = '';
                if (eventsData.length === 0) {
                    eventList.innerHTML = `<div class="text-center p-10 text-gray-500">표시할 이벤트가 없습니다.</div>`;
                } else {
                    const listItemsHtml = await Promise.all(eventsData.map(async (event) => {
                        const { badge, d_day_html } = getEventStatus(event.endDate);
                        const isAdmin = currentUserInfo && ['admin', 'sub-admin'].includes(currentUserInfo.role);
                        const deleteButton = isAdmin ? `<button onclick="deleteEvent('${event.id}', '${event.prize.replace(/'/g, "\\'")}')" class="text-red-500 hover:text-red-700 text-xs">삭제</button>` : '';

                        if (event.type === 'discount') {
                            return `<div class="border-b last:border-b-0"><div class="hidden md:flex w-full items-center px-6 py-4 hover:bg-gray-50"><div class="w-1/5 text-center">${badge}</div><div class="w-2/5 font-bold truncate">${event.prize}</div><div class="w-1/5 text-gray-600 truncate">${event.channelName}</div><div class="w-1/5 text-center"><a href="${event.linkUrl}" target="_blank" class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-600">보러가기</a></div><div class="w-[10%] text-center">${deleteButton}</div></div><a href="${event.linkUrl}" target="_blank" class="block md:hidden p-4"><div class="flex justify-between items-center mb-2"><p class="font-bold w-4/5">${event.prize}</p>${badge}</div><p class="text-sm text-gray-600">${event.channelName}</p></a></div>`;
                        } else {
                            let hasInteracted = false;
                            if (currentUser) {
                                const participationRef = doc(db, "events", event.id, "participants", currentUser.uid);
                                const participationSnap = await getDoc(participationRef);
                                hasInteracted = participationSnap.exists();
                            }
                            const participationCheckbox = `<input type="checkbox" onclick="handleParticipation('${event.id}', 'participated')" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 cursor-pointer" ${hasInteracted ? 'checked' : ''}>`;
                            return `<div class="border-b last:border-b-0">
                                        <div class="hidden md:flex w-full items-center px-6 py-4 hover:bg-gray-50">
                                            <div class="w-[10%] text-center">${d_day_html}</div><div class="w-[10%] text-center">${badge}</div>
                                            <div class="w-[35%] pr-4"><p class="font-bold truncate cursor-pointer" onclick="showDetailPage('${event.id}')">${event.prize}</p></div>
                                            <div class="w-[20%] truncate">${event.channelName}</div><div class="w-[10%]">${event.endDate.replace(/-/g, '.')}</div>
                                            <div class="w-[10%] text-center">${currentUser ? participationCheckbox : ''}</div><div class="w-[5%] text-center">${deleteButton}</div>
                                        </div>
                                        <div class="md:hidden flex items-center p-3 space-x-3 border-b last:border-b-0">
                                            <div class="flex-shrink-0">
                                                ${currentUser ? participationCheckbox : '<div class="w-5 h-5"></div>'}
                                            </div>
                                            <div class="flex-grow min-w-0 cursor-pointer" onclick="showDetailPage('${event.id}')">
                                                <p class="font-semibold truncate">${event.prize}</p>
                                                <p class="text-xs text-gray-500 truncate">${event.channelName}</p>
                                            </div>
                                            <div class="flex-shrink-0 text-right text-sm w-16">
                                                ${d_day_html || badge}
                                            </div>
                                            ${isAdmin ? `<div class="flex-shrink-0 ml-2">${deleteButton}</div>` : ''}
                                        </div>
                                    </div>`;
                        }
                    }));
                    eventList.innerHTML = listItemsHtml.join('');
                }
                paginationContainer.innerHTML = '';
            } catch (error) {
                console.error("이벤트 목록 불러오기 오류: ", error);
                eventList.innerHTML = `<div class="text-center p-10 text-red-500">목록을 불러오는데 실패했습니다.<br>오류 해결을 위해 코드 상단의 [오류 해결] 안내를 확인해주세요.</div>`;
            }
        }
        
        // --- 페이지 전환 함수 ---
        const showPage = (pageId) => {
            [listPage, detailPage, adminDashboardPage].forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        const showListPage = (newMainFilter, newSubFilter = 'all') => {
            mainFilter = newMainFilter;
            subFilter = newSubFilter;
            updateActiveNav();
            showPage('list-page');
            renderEventList();
        }
        
        const setSubFilter = (newSubFilter) => {
            subFilter = newSubFilter;
            updateActiveNav();
            renderEventList();
        }
        
        // --- 인증 및 사용자 정보 처리 ---
        const handleUser = async (user) => {
            if (user) {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                currentUserInfo = userSnap.exists() ? userSnap.data() : null;
                if (!currentUserInfo) { 
                    openModal('terms-modal');
                } else if (!currentUserInfo.termsAgreed) {
                    openModal('terms-modal');
                }
            } else {
                currentUserInfo = null;
            }
            updateUIForAuthState(user);
        }
        
        const agreeAndSignUp = async () => {
            closeModal('terms-modal');
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userRef = doc(db, "users", user.uid);
                const newUserInfo = { email: user.email, displayName: user.displayName, photoURL: user.photoURL, role: "user", createdAt: serverTimestamp(), termsAgreed: true };
                await setDoc(userRef, newUserInfo);
                currentUserInfo = newUserInfo;
                alert("회원가입이 완료되었습니다. 환영합니다!");
            } catch (error) { console.error("회원가입/로그인 오류:", error); alert("처리 중 오류가 발생했습니다."); }
        }

        const updateUIForAuthState = (user) => {
            currentUser = parkgi1100@gmail.com;
            const isAdmin = currentUserInfo && currentUserInfo.role === 'admin';
            const isSubAdmin = currentUserInfo && currentUserInfo.role === 'sub-admin';

            if (user) { 
                authSection.innerHTML = `<button onclick="openModal('logout-options-modal')" class="font-semibold text-gray-700 hover:text-blue-600 hidden md:block">${user.displayName} 님</button>`; 
            } else { 
                authSection.innerHTML = `<button onclick="openModal('login-modal')" class="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow hover:bg-blue-700 hidden md:block">로그인</button>`; 
            }
            
            const adminNavLink = document.getElementById('admin-nav-link');
            if ((isAdmin || isSubAdmin) && !adminNavLink) { 
                const link = document.createElement('a'); link.id = 'admin-nav-link'; link.href = '#'; 
                link.className = 'nav-link pb-1 text-red-500 font-bold'; link.innerText = '관리자'; 
                link.onclick = () => showAdminDashboard(); mainNav.appendChild(link); 
            } else if (!isAdmin && !isSubAdmin && adminNavLink) { 
                adminNavLink.remove(); 
            }
            
            // Mobile Menu
            const mobileNavContainer = document.getElementById('mobile-menu');
            let mobileNavHTML = `
                <a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100" onclick="showListPage('ongoing', 'all'); return false;">진행중인 이벤트</a>
                <a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100" onclick="showListPage('ended'); return false;">종료된 이벤트</a>
                <a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100" onclick="openModal('report-modal')">이벤트 제보</a>
            `;
            if (isAdmin || isSubAdmin) {
                mobileNavHTML += `<a href="#" class="block py-2 px-4 text-sm text-red-500 font-bold hover:bg-gray-100" onclick="showAdminDashboard()">관리자</a>`;
            }
            mobileNavHTML += '<hr class="my-2">';
            if(user) {
                mobileNavHTML += `<a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100" onclick="openModal('logout-options-modal')">${user.displayName}님 (계정관리)</a>`;
            } else {
                mobileNavHTML += `<a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100" onclick="openModal('login-modal')">로그인 / 회원가입</a>`;
            }
            mobileNavContainer.innerHTML = mobileNavHTML;

        };

        const login = async () => { 
            const provider = new GoogleAuthProvider(); 
            try { 
                await signInWithPopup(auth, provider); 
                closeModal('login-modal'); 
            } 
            catch (error) { console.error("Google 로그인 오류:", error); alert("로그인 중 오류가 발생했습니다."); } 
        };

        const logout = async () => { 
            try { await signOut(auth); closeModal('logout-options-modal');} 
            catch (error) { console.error("로그아웃 오류:", error); } 
        };
        
        const deleteAccount = async () => {
            if (!currentUser) return;
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await deleteDoc(userRef);
                await deleteUser(currentUser);
                closeModal('delete-account-modal');
                alert("회원탈퇴가 정상적으로 처리되었습니다. 이용해주셔서 감사합니다.");
            } catch (error) {
                console.error("회원탈퇴 오류: ", error);
                alert("회원탈퇴 중 오류가 발생했습니다. 재로그인 후 다시 시도해주세요.");
            }
        };

        const showDetailPage = async (id) => {
            if (!currentUser) {
                alert("로그인이 필요한 서비스입니다.");
                openModal('login-modal');
                return;
            }
            const eventDocRef = doc(db, "events", id);
            try {
                const docSnap = await getDoc(eventDocRef);
                if (!docSnap.exists()) { detailPage.innerHTML = `<div class="text-center p-10 text-red-500">해당 이벤트를 찾을 수 없습니다.</div>`; showPage('detail-page'); return; }
                const event = { id: docSnap.id, ...docSnap.data() };
                const { badge, d_day_html } = getEventStatus(event.endDate);
                let participationStatus = null;
                if (currentUser && (event.type === 'youtube' || event.type === 'airdrop' || event.type === 'other')) { 
                    const participationRef = doc(db, "events", event.id, "participants", currentUser.uid); 
                    const participationSnap = await getDoc(participationRef); 
                    if(participationSnap.exists()) {
                        participationStatus = participationSnap.data().status;
                    }
                }
                let detailHTML = `<div class="bg-white p-8 rounded-lg shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2 md:mb-0">${event.prize}</h1>
                        <div class="flex items-center space-x-3">${badge} ${d_day_html}</div>
                    </div>
                    <p class="text-lg text-gray-600 mb-6">채널명: ${event.channelName}</p>
                    <div class="border-y py-6 mb-6">
                        <h2 class="text-xl font-semibold mb-3">상세 정보</h2>
                        <p class="mb-4 whitespace-pre-wrap">${event.description || '상세 정보가 없습니다.'}</p>
                        <a href="${event.linkUrl}" target="_blank" class="inline-block bg-red-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-red-700">링크 바로가기 &rarr;</a>
                    </div>`;
                if (event.type === 'youtube' || event.type === 'airdrop' || event.type === 'other') { 
                    const participatedBtnClass = participationStatus === 'participated' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800';
                    const notInterestedBtnClass = participationStatus === 'not_interested' ? 'bg-gray-500 text-white' : 'bg-gray-200 text-gray-800';
                    detailHTML += `<div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="flex items-center space-x-3">
                            <button onclick="handleParticipation('${event.id}', 'participated')" class="font-semibold px-4 py-2 rounded-lg ${participatedBtnClass}">👍 참여하기 (${event.participatedCount || 0})</button>
                            <button onclick="handleParticipation('${event.id}', 'not_interested')" class="font-semibold px-4 py-2 rounded-lg ${notInterestedBtnClass}">👎 관심없음 (${event.notInterestedCount || 0})</button>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="showListPage('${mainFilter}', '${subFilter}')" class="font-semibold px-6 py-3 rounded-lg bg-gray-600 text-white hover:bg-gray-700">&larr; 목록으로</button>
                        </div>
                    </div>`; 
                }
                detailHTML += `</div>`;
                detailPage.innerHTML = detailHTML;
                showPage('detail-page');
            } catch (error) { console.error("상세 페이지 로딩 오류: ", error); detailPage.innerHTML = `<div class="text-center p-10 text-red-500">상세 정보를 불러오는 데 실패했습니다.</div>`; }
        };

        const openModal = (modalId, data = {}) => { 
            const modal = document.getElementById(modalId); 
            if (modalId === 'register-modal' && data.linkUrl) { 
                const form = modal.querySelector('form'); 
                if (form) {
                    form.linkUrl.value = data.linkUrl;
                    form.description.value = data.summary || '';
                }
            } 
            modal.classList.remove('hidden'); 
        };

        const closeModal = (modalId) => { 
            document.getElementById(modalId).classList.add('hidden'); 
        };

        const renderModals = () => { 
            document.getElementById('login-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm"><h2 class="text-2xl font-bold text-center mb-6">로그인 또는 회원가입</h2><div class="space-y-4"><button onclick="login()" class="w-full flex items-center justify-center bg-white border border-gray-300 py-3 rounded-lg hover:bg-gray-200 font-semibold">Google 계정으로 로그인</button><div class="text-center text-sm text-gray-500">또는</div><button onclick="openModal('terms-modal'); closeModal('login-modal');" class="w-full flex items-center justify-center bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">회원가입</button></div><button onclick="closeModal('login-modal')" class="mt-6 w-full text-center text-gray-500">닫기</button></div>`; 
            document.getElementById('report-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">이벤트 제보하기</h2><form onsubmit="handleReportSubmit(event)"><div class="space-y-4"><input name="linkUrl" type="url" placeholder="이벤트 링크" required class="w-full p-3 border rounded-lg"><textarea name="summary" placeholder="이벤트 내용 요약" required class="w-full p-3 border rounded-lg h-24"></textarea></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('report-modal')" class="px-6 py-2 bg-gray-200 rounded-lg">취소</button><button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg">제출</button></div></form></div>`; 
            document.getElementById('register-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">새 이벤트 등록</h2><form onsubmit="handleEventSubmit(event)"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">이벤트 종류</label><select name="eventType" class="w-full p-3 border rounded-lg"><option value="youtube">유튜브(SNS)</option><option value="discount">할인이벤트</option><option value="airdrop">에어드랍</option><option value="other">기타</option></select></div><input type="text" name="prize" placeholder="상품명/내용" required class="w-full p-3 border rounded-lg"><input type="text" name="channelName" placeholder="채널명/판매처" required class="w-full p-3 border rounded-lg"><input type="url" name="linkUrl" placeholder="이벤트 링크 (https://...)" required class="w-full p-3 border rounded-lg"><input type="date" name="endDate" class="w-full p-3 border rounded-lg"><textarea name="description" placeholder="상세 내용 (참여 방법 등)" required class="w-full p-3 border rounded-lg h-24"></textarea></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('register-modal')" class="px-6 py-2 bg-gray-200 rounded-lg">취소</button><button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg">등록</button></div></form></div>`; 
            document.getElementById('terms-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">YouVent 서비스 약관 동의</h2><p class="text-gray-600 mb-6">서비스를 이용하시려면 아래의 이용약관과 개인정보 처리방침에 동의해주세요.</p><div class="space-y-4"><div class="space-y-2"> <h3 class="font-semibold">이용약관</h3> <div class="terms-content"><strong>제1조 (목적)</strong><br>본 약관은 YouVent(이하 '회사')가 제공하는 모든 서비스(이하 '서비스')의 이용 조건 및 절차, 회원과 회사의 권리, 의무 및 책임사항 등 기타 필요한 사항을 규정함을 목적으로 합니다.<br><br><strong>제2조 (용어의 정의)</strong><br>본 약관에서 사용하는 용어의 정의는 다음과 같습니다.<br>1. '서비스'라 함은 회사가 제공하는 모든 이벤트 정보 제공 서비스를 의미합니다.<br>2. '회원'이라 함은 회사에 개인정보를 제공하여 회원등록을 한 자로서, 회사의 정보를 지속적으로 제공받으며, 회사가 제공하는 서비스를 계속적으로 이용할 수 있는 자를 말합니다.<br><br><strong>제3조 (약관의 효력 및 변경)</strong><br>1. 본 약관은 서비스를 이용하고자 하는 모든 회원에 대하여 그 효력을 발생합니다.<br>2. 회사는 필요한 경우 관련 법령을 위배하지 않는 범위에서 본 약관을 개정할 수 있습니다.</div><label class="flex items-center"><input type="checkbox" id="terms-agree-1" class="form-checkbox h-5 w-5"> <span class="ml-2 text-sm">이용약관에 동의합니다. (필수)</span></label></div><div class="space-y-2"> <h3 class="font-semibold">개인정보 처리방침</h3> <div class="terms-content"><strong>1. 수집하는 개인정보의 항목</strong><br>회사는 회원가입, 원활한 고객상담, 각종 서비스의 제공을 위해 최초 회원가입 당시 아래와 같은 최소한의 개인정보를 필수항목으로 수집하고 있습니다.<br>- 구글 계정 정보: 이메일 주소, 이름, 프로필 사진<br><br><strong>2. 개인정보의 수집 및 이용 목적</strong><br>회사는 수집한 개인정보를 다음의 목적을 위해 활용합니다.<br>- 회원 관리: 회원제 서비스 이용에 따른 본인확인, 개인 식별, 불량회원의 부정 이용 방지와 비인가 사용 방지<br><br><strong>3. 개인정보의 보유 및 이용기간</strong><br>회원의 개인정보는 원칙적으로 개인정보의 수집 및 이용목적이 달성되면 지체 없이 파기합니다. 단, 회원탈퇴 시 모든 정보는 즉시 삭제됩니다.</div><label class="flex items-center"><input type="checkbox" id="terms-agree-2" class="form-checkbox h-5 w-5"> <span class="ml-2 text-sm">개인정보 처리방침에 동의합니다. (필수)</span></label></div></div><div class="mt-6 flex justify-end"><button id="agree-btn" onclick="agreeAndSignUp()" class="px-6 py-2 bg-blue-600 text-white rounded-lg disabled:bg-gray-400" disabled>전체 동의하고 회원가입</button></div></div>`;
            document.getElementById('logout-options-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-xs"><h2 class="text-xl font-bold text-center mb-6">계정 관리</h2><div class="space-y-3"><button onclick="logout()" class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg hover:bg-gray-300">로그아웃</button><button onclick="closeModal('logout-options-modal'); openModal('delete-account-modal');" class="w-full text-red-600 py-2 hover:underline">회원탈퇴</button></div><button onclick="closeModal('logout-options-modal')" class="mt-4 w-full text-center text-gray-500 text-sm">닫기</button></div>`;
            document.getElementById('delete-account-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold text-center mb-4">회원 탈퇴</h2><p class="text-center text-gray-600 mb-6">정말로 탈퇴하시겠습니까?<br>모든 활동 기록이 영구적으로 삭제되며 복구할 수 없습니다.</p><div class="flex justify-center space-x-4"><button onclick="closeModal('delete-account-modal')" class="px-6 py-2 bg-gray-200 rounded-lg">취소</button><button onclick="deleteAccount()" class="px-6 py-2 bg-red-600 text-white rounded-lg">탈퇴하기</button></div></div>`;
            document.getElementById('terms-of-service-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl"><h2 class="text-2xl font-bold mb-4">이용약관</h2><div class="terms-content max-h-96"><strong>제1조 (목적)</strong><br>본 약관은 YouVent(이하 '회사')가 제공하는 모든 서비스(이하 '서비스')의 이용 조건 및 절차, 회원과 회사의 권리, 의무 및 책임사항 등 기타 필요한 사항을 규정함을 목적으로 합니다.<br><br><strong>제2조 (용어의 정의)</strong><br>본 약관에서 사용하는 용어의 정의는 다음과 같습니다.<br>1. '서비스'라 함은 회사가 제공하는 모든 이벤트 정보 제공 서비스를 의미합니다.<br>2. '회원'이라 함은 회사에 개인정보를 제공하여 회원등록을 한 자로서, 회사의 정보를 지속적으로 제공받으며, 회사가 제공하는 서비스를 계속적으로 이용할 수 있는 자를 말합니다.<br><br><strong>제3조 (약관의 효력 및 변경)</strong><br>1. 본 약관은 서비스를 이용하고자 하는 모든 회원에 대하여 그 효력을 발생합니다.<br>2. 회사는 필요한 경우 관련 법령을 위배하지 않는 범위에서 본 약관을 개정할 수 있습니다.</div><div class="mt-6 flex justify-end"><button onclick="closeModal('terms-of-service-modal')" class="px-6 py-2 bg-gray-200 rounded-lg">닫기</button></div></div>`;
            document.getElementById('privacy-policy-modal').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl"><h2 class="text-2xl font-bold mb-4">개인정보처리방침</h2><div class="terms-content max-h-96"><strong>1. 수집하는 개인정보의 항목</strong><br>회사는 회원가입, 원활한 고객상담, 각종 서비스의 제공을 위해 최초 회원가입 당시 아래와 같은 최소한의 개인정보를 필수항목으로 수집하고 있습니다.<br>- 구글 계정 정보: 이메일 주소, 이름, 프로필 사진<br><br><strong>2. 개인정보의 수집 및 이용 목적</strong><br>회사는 수집한 개인정보를 다음의 목적을 위해 활용합니다.<br>- 회원 관리: 회원제 서비스 이용에 따른 본인확인, 개인 식별, 불량회원의 부정 이용 방지와 비인가 사용 방지<br><br><strong>3. 개인정보의 보유 및 이용기간</strong><br>회원의 개인정보는 원칙적으로 개인정보의 수집 및 이용목적이 달성되면 지체 없이 파기합니다. 단, 회원탈퇴 시 모든 정보는 즉시 삭제됩니다.</div><div class="mt-6 flex justify-end"><button onclick="closeModal('privacy-policy-modal')" class="px-6 py-2 bg-gray-200 rounded-lg">닫기</button></div></div>`;

            const agreeBtn = document.getElementById('agree-btn');
            const chk1 = document.getElementById('terms-agree-1');
            const chk2 = document.getElementById('terms-agree-2');
            [chk1, chk2].forEach(chk => { chk.addEventListener('change', () => { agreeBtn.disabled = !(chk1.checked && chk2.checked); }); });
        };
        
        const showAdminDashboard = async () => {
            if (!currentUserInfo || !['admin', 'sub-admin'].includes(currentUserInfo.role)) {
                alert('권한이 없습니다.');
                return;
            }
            showPage('admin-dashboard-page');
            renderReportList();
        };

        const renderReportList = async () => {
            const reportListDiv = document.getElementById('reportList');
            reportListDiv.innerHTML = '제보 목록을 불러오는 중...';
            try {
                const q = query(reportsCollection, where("status", "==", "pending"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    reportListDiv.innerHTML = '<p class="text-gray-500">새로운 제보가 없습니다.</p>';
                    return;
                }
                let reportsHtml = '<div class="divide-y divide-gray-200">';
                querySnapshot.forEach(doc => {
                    const report = doc.data();
                    reportsHtml += `
                        <div class="py-3">
                            <p class="font-semibold text-gray-800">${report.summary}</p>
                            <a href="${report.linkUrl}" target="_blank" class="text-sm text-blue-500 hover:underline">${report.linkUrl}</a>
                            <div class="mt-2 flex space-x-2">
                                <button onclick="approveReport('${doc.id}', '${report.linkUrl}', '${report.summary}')" class="bg-blue-500 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-600">승인</button>
                                <button onclick="rejectReport('${doc.id}')" class="bg-red-500 text-white px-3 py-1 text-sm rounded-md hover:bg-red-600">거절</button>
                            </div>
                        </div>
                    `;
                });
                reportsHtml += '</div>';
                reportListDiv.innerHTML = reportsHtml;
            } catch (error) {
                console.error("제보 목록 로딩 오류: ", error);
                reportListDiv.innerHTML = '<p class="text-red-500">제보 목록을 불러오는데 실패했습니다. Firebase 보안 규칙과 색인을 확인해주세요.</p>';
            }
        };

        const approveReport = async (reportId, linkUrl, summary) => {
            openModal('register-modal', { linkUrl, summary });
            await updateDoc(doc(db, "reports", reportId), { status: "approved" });
        };

        const rejectReport = async (reportId) => {
            if (confirm("이 제보를 삭제하시겠습니까?")) {
                await deleteDoc(doc(db, "reports", reportId));
                renderReportList();
            }
        };

        const deleteEvent = async (eventId, eventPrize) => {
             if (!currentUserInfo || !['admin', 'sub-admin'].includes(currentUserInfo.role)) {
                alert('삭제 권한이 없습니다.');
                return;
            }
            if (confirm(`정말로 '${eventPrize}' 이벤트를 삭제하시겠습니까?`)) {
                try {
                    await deleteDoc(doc(db, "events", eventId));
                    alert('이벤트가 삭제되었습니다.');
                    renderEventList();
                } catch (error) {
                    console.error("이벤트 삭제 오류:", error);
                    alert("이벤트 삭제 중 오류가 발생했습니다.");
                }
            }
        }

        // --- 함수 전역 할당 ---
        window.showListPage = showListPage;
        window.setSubFilter = setSubFilter;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.login = login;
        window.logout = logout;
        window.deleteAccount = deleteAccount;
        window.agreeAndSignUp = agreeAndSignUp;
        window.handleParticipation = handleParticipation;
        window.showDetailPage = showDetailPage;
        window.handleEventSubmit = handleEventSubmit;
        window.handleReportSubmit = handleReportSubmit;
        window.showAdminDashboard = showAdminDashboard;
        window.deleteEvent = deleteEvent;
        window.approveReport = approveReport;
        window.rejectReport = rejectReport;
        
        // --- 초기화 ---
        window.onload = () => {
            renderModals();
            onAuthStateChanged(auth, async (user) => {
                await handleUser(user);
                showListPage(mainFilter, subFilter);
            });
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        };
    </script>
</body>
</html>
