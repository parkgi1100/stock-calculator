<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í™˜ì°¨ìµ ë‹¤ì´ì–´ë¦¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        /* --- ê¸°ì¡´ CSSëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        :root {
          --primary-color: #3182F6;
          --background-color: #F2F4F6;
          --card-background-color: #FFFFFF;
          --text-color: #333D4B;
          --subtext-color: #8B95A1;
          --border-color: #E5E8EB;
          --success-color: #2E8B57;
          --danger-color: #D94242;
        }
        body {
          font-family: 'Noto Sans KR', 'Apple SD Gothic Neo', sans-serif;
          background-color: var(--background-color);
          color: var(--text-color);
          margin: 0;
          padding: 16px;
          font-size: 14px;
          -webkit-font-smoothing: antialiased;
        }
        .card { background-color: var(--card-background-color); border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); margin-bottom: 16px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 16px; }
        h2 { font-size: 16px; font-weight: 700; margin: 0; color: var(--primary-color); flex-shrink: 0; }
        .tools { display: flex; gap: 8px; flex-shrink: 0; }
        .tools button, .tools label { font-size: 13px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #F9FAFB; color: #4E5968; padding: 8px 12px; cursor: pointer; font-weight: 500; text-align: center; white-space: nowrap; }
        .tools input[type="file"] { display: none; }
        .input-section { display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 8px; }
        .input-section input { flex: 1 1 auto; font-size: 14px; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #F9FAFB; min-width: 0; }
        .input-section input[type="date"] { flex-grow: 2; }
        .input-section input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(49, 130, 246, 0.2); }
        .input-section .submit-btn { flex-grow: 1; border: none; background-color: var(--primary-color); color: white; font-weight: 700; cursor: pointer; }
        .tab-section { display: flex; gap: 4px; background-color: #E9ECEF; border-radius: 8px; padding: 4px; }
        .tab-section button { flex: 1; padding: 8px 0; background-color: transparent; border: none; font-size: 14px; border-radius: 6px; color: var(--subtext-color); font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .tab-section button.active { background-color: var(--card-background-color); color: var(--primary-color); font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .date-filter { display:flex; gap: 6px; align-items: center; padding-top: 16px; }
        .date-filter input[type="date"] { flex: 1 1 auto; min-width: 90px; border:1px solid #d3d8dd; padding: 6px; border-radius: 6px; font-size: 13px;}
        .date-filter button { flex-shrink: 0; padding: 7px 10px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer; white-space: nowrap;}
        .date-filter .btn-search { background: var(--primary-color); color: white;}
        .date-filter .btn-reset { background: #E9ECEF; color:var(--subtext-color);}
        .summary { font-size: 15px; font-weight: 500; padding: 16px; background-color: #F0F6FF; color: #194583; border-radius: 12px; text-align: center; margin-top: 16px; }
        .table-container { width: 100%; }
        .result-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); table-layout: fixed; }
        .result-table th, .result-table td { text-align: center; padding: 12px 4px; border-bottom: 1px solid var(--border-color); font-size: 12px; vertical-align: middle; }
        .result-table thead { background-color: #F9FAFB; }
        .result-table th { color: var(--subtext-color); font-weight: 500; padding: 10px 4px; }
        .result-table tr:last-child td { border-bottom: none; }
        .btn-sm { background: none; border: 1px solid var(--border-color); border-radius: 6px; padding: 4px 8px; font-size: 11px; cursor: pointer; min-width: 45px; white-space: nowrap; }
        .btn-detail { color: var(--primary-color); }
        .btn-delete { color: var(--danger-color); font-weight: 700; width: 100%; padding: 10px; margin-top: 10px; }
        .status { font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 16px; display: inline-block; white-space: nowrap; }
        .status-ing { background-color: #FFF8E5; color: #D97706; }
        .status-done { background-color: #E6F8EA; color: #14AD5E; }
        .profit-plus { color: var(--danger-color); }
        .profit-minus { color: var(--primary-color); }
        .profit-neutral { color: var(--subtext-color); }
        .details-content { display: none; background-color: #F9FAFB; padding: 16px; }
        .details-content.show { display: table-cell; }
        .detail-grid { display: grid; grid-template-columns: auto 1fr auto 1fr; gap: 8px 16px; align-items: center; font-size: 13px; }
        .detail-grid strong { color: var(--subtext-color); font-weight: 500; }
        .sub-table { margin-top: 16px; border-top: 1px solid var(--border-color); padding-top: 16px; }
        .sub-table table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .sub-table th, .sub-table td { text-align: center; padding: 8px 4px; border-bottom: 1px solid var(--border-color); }
        .sub-table th { background-color: #F3F4F6; font-weight: 500; }
        .sub-table input { width: 95%; box-sizing: border-box; text-align: center; border: 1px solid #D1D5DB; border-radius: 4px; padding: 4px; }
        .del-partial-btn { background: none; border: none; cursor: pointer; font-size: 16px; }
        .add-partial-btn { width: 100%; background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 6px; padding: 6px; cursor: pointer; font-weight: 500; }
        
        /* --- ğŸ‘‡ ë¡œê·¸ì¸ ê¸°ëŠ¥ì— í•„ìš”í•œ ìƒˆ CSS ìŠ¤íƒ€ì¼ --- */
        #auth-status {
          margin-left: auto;
          display: flex;
          align-items: center;
          gap: 12px;
          font-size: 13px;
        }
        #auth-status button {
          font-size: 13px;
          border-radius: 8px;
          border: 1px solid var(--primary-color);
          background-color: var(--primary-color);
          color: white;
          padding: 8px 12px;
          cursor: pointer;
          font-weight: 500;
        }
        #logout-btn {
            background-color: #F9FAFB;
            color: #4E5968;
            border-color: var(--border-color);
        }
        #user-email { font-weight: 500; }

        .modal-overlay {
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.5);
          display: none; /* JSë¡œ ì»¨íŠ¸ë¡¤ */
          justify-content: center;
          align-items: center;
          z-index: 1000;
        }
        .modal-content {
          background: white;
          padding: 24px;
          border-radius: 16px;
          width: 90%;
          max-width: 380px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h3 {
          margin-top: 0;
          margin-bottom: 16px;
          text-align: center;
          font-size: 18px;
        }
        .modal-input {
          width: 100%;
          padding: 12px;
          border: 1px solid var(--border-color);
          border-radius: 8px;
          margin-bottom: 12px;
          box-sizing: border-box;
          font-size: 15px;
        }
        .modal-buttons {
          display: flex;
          gap: 10px;
          margin-top: 8px;
        }
        .modal-buttons button {
          flex: 1;
          padding: 12px;
          border-radius: 8px;
          border: none;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
        }
        #modal-login-btn {
          background-color: var(--primary-color);
          color: white;
        }
        #modal-signup-btn {
          background-color: #E9ECEF;
          color: var(--subtext-color);
        }
        #modal-close-btn {
          position: absolute;
          top: 10px;
          right: 15px;
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: var(--subtext-color);
        }
        #modal-error {
            color: var(--danger-color);
            font-size: 12px;
            text-align: center;
            margin-top: 16px;
            min-height: 18px;
        }
    </style>
</head>
<body>

<div id="auth-status" class="header-row">
    <button id="login-btn" onclick="openLoginModal()">ë¡œê·¸ì¸</button>
    <div id="user-info" style="display: none;">
        <span id="user-email"></span>ë‹˜
        <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<main id="app-content" style="display: none;">
    <div class="wrap">
        <div class="card">
            <div class="header-row">
                <h2>í™˜ì°¨ìµ ë‹¤ì´ì–´ë¦¬ ğŸ’¸</h2>
                <div class="tools">
                    <button onclick="exportCSV()">ì—‘ì…€</button>
                    <button onclick="exportData()">ë°±ì—…</button>
                    <label>ë¶ˆëŸ¬ì˜¤ê¸°<input type="file" id="importFile" accept=".json" onchange="importData(event)"></label>
                </div>
            </div>
            <div class="input-section">
                <div class="input-row">
                    <input type="number" id="money" placeholder="í™˜ì „ê¸ˆì•¡(ì›)" required>
                    <input type="number" id="rate_in" placeholder="í™˜ì „í™˜ìœ¨" required step="any">
                    <input type="number" id="interest" placeholder="ì´ììœ¨(%)" step="any">
                </div>
                <div class="input-row">
                    <input type="date" id="date_in" title="í™˜ì „ë‚ ì§œ(ì—†ìœ¼ë©´ ì˜¤ëŠ˜)">
                    <button type="button" class="submit-btn" onclick="addRow()">ê¸°ë¡</button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="tab-section">
                <button onclick="showTab('all')" class="active">ì „ì²´</button>
                <button onclick="showTab('ing')">ì§„í–‰ì¤‘</button>
                <button onclick="showTab('done')">ì™„ë£Œ</button>
            </div>
            <div class="date-filter">
                <input type="date" id="start-date">
                <span>~</span>
                <input type="date" id="end-date">
                <button onclick="renderTable()" class="btn-search">ì¡°íšŒ</button>
                <button onclick="resetDateFilter()" class="btn-reset">ì´ˆê¸°í™”</button>
            </div>
            <div class="summary" id="summary"></div>
        </div>
        <div class="table-container">
            <table class="result-table">
                <thead>
                <tr>
                    <th>ìƒíƒœ</th>
                    <th>í™˜ì „ê¸ˆì•¡</th>
                    <th>í™˜ì „ë‚ ì§œ</th>
                    <th>ìˆœì´ìµ</th>
                    <th>ìƒì„¸</th>
                </tr>
                </thead>
                <tbody id="record-list"></tbody>
            </table>
        </div>
    </div>
</main>

<div id="login-modal" class="modal-overlay">
    <div class="modal-content">
        <button id="modal-close-btn" onclick="closeLoginModal()">Ã—</button>
        <h3>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h3>
        <input class="modal-input" type="email" id="modal-email" placeholder="ì´ë©”ì¼">
        <input class="modal-input" type="password" id="modal-password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)">
        <div id="modal-error"></div>
        <div class="modal-buttons">
            <button id="modal-signup-btn">íšŒì›ê°€ì…</button>
            <button id="modal-login-btn">ë¡œê·¸ì¸</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // ğŸ‘‡ğŸ‘‡ ì—¬ê¸°ì— ë‹¹ì‹ ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì • ê°’ì„ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”! ğŸ‘‡ğŸ‘‡
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- ì „ì—­ ë³€ìˆ˜ ---
    let records = [];
    let currentTab = 'all';
    let currentUser = null;

    // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
    const getEl = (id) => document.getElementById(id);
    function today() { return new Date().toISOString().slice(0, 10); }
    function numberFormat(n) { return Math.round(n).toLocaleString('ko-KR'); }

    // --- ğŸ‘‡ ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ë¡œì§ì„ Firestoreë¡œ ë³€ê²½ ---
    async function saveToFirestore() {
      if (!currentUser) return; // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆë©´ ì €ì¥ ì•ˆ í•¨
      records.forEach((r, index) => {
          if (!r.id) r.id = `record_${Date.now()}_${index}`;
      });
      try {
        // 'diaries' ì»¬ë ‰ì…˜ì— ìœ ì €ì˜ ê³ ìœ  ID(uid)ë¡œ ë¬¸ì„œë¥¼ ë§Œë“¤ê³  records ë°°ì—´ì„ í†µì§¸ë¡œ ì €ì¥
        await db.collection('diaries').doc(currentUser.uid).set({ records: records });
      } catch (error) {
        console.error("Firestore ì €ì¥ ì˜¤ë¥˜: ", error);
        alert("ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }

    async function loadFromFirestore() {
      if (!currentUser) return; // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆë©´ ë¶ˆëŸ¬ì˜¤ì§€ ì•ŠìŒ
      try {
        const doc = await db.collection('diaries').doc(currentUser.uid).get();
        if (doc.exists) {
          records = doc.data().records || [];
          let needsSave = false;
          records.forEach((r, index) => {
              if (!r.id) {
                  r.id = `record_${Date.now()}_${index}`;
                  needsSave = true;
              }
          });
          if (needsSave) await saveToFirestore();
        } else {
          records = []; // ì´ ìœ ì €ì˜ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì‹œì‘
        }
      } catch (error) {
        console.error("Firestore ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ", error);
        alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        records = [];
      }
    }

    // --- ğŸ‘‡ ê¸°ì¡´ í•¨ìˆ˜ë“¤ì—ì„œ saveStorage()ë¥¼ saveToFirestore()ë¡œ ë³€ê²½ ---
    async function addRow() {
      // ... (ê¸°ì¡´ addRow ë¡œì§ê³¼ ë™ì¼)
      if (getEl('money').value === '' || getEl('rate_in').value === '') return alert("í™˜ì „ê¸ˆì•¡ê³¼ í™˜ì „í™˜ìœ¨ì„ ì±„ì›Œì£¼ì„¸ìš”!");
      records.unshift({
        money: Number(getEl('money').value),
        rate_in: Number(getEl('rate_in').value),
        interest: Number(getEl('interest').value) || 0,
        date_in: getEl('date_in').value || today(),
        id: 'record_' + Date.now(),
        isDetailVisible: false,
        partial_exchanges: []
      });
      await saveToFirestore(); // ë³€ê²½ëœ ë¶€ë¶„
      renderTable();
      getEl('money').value = ''; getEl('rate_in').value = ''; getEl('interest').value = ''; getEl('date_in').value = today();
    }

    async function delRow(recordId) {
      if (confirm("ì •ë§ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”?")) {
        records = records.filter(r => r.id !== recordId);
        await saveToFirestore(); // ë³€ê²½ëœ ë¶€ë¶„
        renderTable();
      }
    }
    
    async function addPartialExchange(recordId) {
      // ... (ê¸°ì¡´ ë¡œì§ê³¼ ê±°ì˜ ë™ì¼)
      const record = records.find(r => r.id === recordId); if (!record) return;
      const amount = Number(getEl(`partial_amount_${record.id}`).value);
      const rate_out = Number(getEl(`partial_rate_out_${record.id}`).value);
      if (!amount || !rate_out) return alert("ê¸ˆì•¡/í™˜ìœ¨ ì…ë ¥í•˜ì„¸ìš”!");
      const currentPaid = record.partial_exchanges.reduce((sum, p) => sum + p.amount, 0);
      if (currentPaid + amount > record.money + 1) return alert("ì „ì²´ í™˜ì „ê¸ˆì•¡ ì´ˆê³¼!");
      
      record.partial_exchanges.push({ amount, rate_out, date_out: getEl(`partial_date_out_${record.id}`).value || today(), fee: Number(getEl(`partial_fee_${record.id}`).value) || 0, id: 'p_' + Date.now() });
      record.partial_exchanges.sort((a, b) => new Date(a.date_out) - new Date(b.date_out));
      
      await saveToFirestore(); // ë³€ê²½ëœ ë¶€ë¶„
      renderTable();
    }
    
    async function delPartial(recordId, partialId) {
      const record = records.find(r => r.id === recordId);
      if (record) {
        record.partial_exchanges = record.partial_exchanges.filter(p => p.id !== partialId);
        await saveToFirestore(); // ë³€ê²½ëœ ë¶€ë¶„
        renderTable();
      }
    }
    
    async function updatePartialFee(recordId, partialId, newFee) {
        const record = records.find(r => r.id === recordId);
        if (record) {
            const partial = record.partial_exchanges.find(p => p.id === partialId);
            if (partial) partial.fee = Number(newFee);
            await saveToFirestore(); // ë³€ê²½ëœ ë¶€ë¶„
            renderTable();
        }
    }
    
    // toggleDetailì€ í™”ë©´ í‘œì‹œë§Œ ë°”ê¾¸ë¯€ë¡œ async/await ë¶ˆí•„ìš”
    function toggleDetail(recordId) {
        const record = records.find(r => r.id === recordId);
        if (record) {
          record.isDetailVisible = !record.isDetailVisible;
          renderTable();
        }
    }
    
    // --- UI ë Œë”ë§ ë° ê¸°íƒ€ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ê³¼ ê±°ì˜ ë™ì¼) ---
    function renderTable() {
      // ... (ê¸°ì¡´ renderTable ë¡œì§ì€ ë³€ê²½ ì—†ìŒ)
      let baseRecords = [...records];
      baseRecords.sort((a, b) => new Date(b.date_in) - new Date(a.date_in));

      let filteredRecords = baseRecords;
      if (currentTab === 'ing') {
        filteredRecords = baseRecords.filter(r => r.partial_exchanges.reduce((a,p)=>a+p.amount,0) < r.money);
      } else if (currentTab === 'done') {
        filteredRecords = baseRecords.filter(r => r.partial_exchanges.reduce((a,p)=>a+p.amount,0) >= r.money);
      }

      const startDateVal = getEl('start-date').value;
      const endDateVal = getEl('end-date').value;
      if(startDateVal && endDateVal) {
        const start = new Date(startDateVal); const end = new Date(endDateVal); end.setHours(23, 59, 59, 999);
        filteredRecords = filteredRecords.filter(r => { const d = new Date(r.date_in); return d >= start && d <= end; });
      }

      const recordList = getEl('record-list');
      recordList.innerHTML = "";
      let totalNetProfit = 0;

      if (filteredRecords.length === 0) {
        recordList.innerHTML = "<tr><td colspan='5' style='text-align:center; color: #8B95A1; padding: 40px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</td></tr>";
      }

      filteredRecords.forEach(rec => {
        const paidSum = rec.partial_exchanges.reduce((a,p)=>a+p.amount,0);
        const isDone = paidSum >= rec.money;
        let fx_profit_total = 0;
        rec.partial_exchanges.forEach(p => { if (p.rate_out > 0) fx_profit_total += (p.amount - (p.amount / p.rate_out * rec.rate_in)); });
        const total_fee = rec.partial_exchanges.reduce((s, p) => s + (p.fee || 0), 0);
        let d1 = new Date(rec.date_in);
        let d2 = rec.partial_exchanges.length ? new Date(rec.partial_exchanges[rec.partial_exchanges.length-1].date_out) : new Date();
        const days = isDone ? Math.max(0, Math.round((d2 - d1)/(1000*60*60*24))) : '-';
        const int_fee = isDone ? (rec.money * rec.interest / 100 * days / 365) : 0;
        const net_profit = fx_profit_total - int_fee - total_fee;
        if (isDone) totalNetProfit += net_profit;
        const profitClass = !isDone ? 'profit-neutral' : (net_profit >= 0 ? 'profit-plus' : 'profit-minus');
        const row = recordList.insertRow();
        row.innerHTML = `<td><span class="status ${isDone ? 'status-done' : 'status-ing'}">${isDone ? 'ì™„ë£Œ' : 'ì§„í–‰ì¤‘'}</span></td><td>${numberFormat(rec.money)}ì›</td><td>${rec.date_in.substring(5)}</td><td><b class="${profitClass}">${isDone ? (net_profit >= 0 ? '+' : '') + numberFormat(net_profit) + 'ì›' : '-'}</b></td><td><button class="btn-sm btn-detail" onclick="toggleDetail('${rec.id}')">${rec.isDetailVisible ? 'â–² ë‹«ê¸°' : 'â–¼ ìƒì„¸'}</button></td>`;
        if (rec.isDetailVisible) {
          const detailRow = recordList.insertRow(); detailRow.insertCell().colSpan = 5;
          detailRow.cells[0].className = 'details-content show';
          detailRow.cells[0].innerHTML = `<div class="detail-grid"><strong>í™˜ì „í™˜ìœ¨</strong><span>${rec.rate_in}</span><strong>í™˜ì „ê¸ˆì•¡($)</strong><span>${(rec.money/rec.rate_in).toFixed(2)}$</span><strong>ì´ììœ¨</strong><span>${rec.interest}%</span><strong>ê²½ê³¼ì¼ìˆ˜</strong><span>${days}ì¼</span><strong>ì´ìë¹„ìš©</strong><span>${numberFormat(int_fee)}ì›</span><strong>ìˆ˜ìˆ˜ë£Œí•©ê³„</strong><span>${numberFormat(total_fee)}ì›</span></div><div class="sub-table"><table><thead><tr><th>#</th><th>ë‚ ì§œ</th><th>ê¸ˆì•¡</th><th>í™˜ìœ¨</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ì‚­ì œ</th></tr></thead><tbody>${rec.partial_exchanges.map((p, idx) => `<tr><td>${idx+1}</td><td>${p.date_out}</td><td>${numberFormat(p.amount)}</td><td>${p.rate_out}</td><td><input type="number" value="${p.fee || 0}" onchange="updatePartialFee('${rec.id}', '${p.id}', this.value)"></td><td><button class="del-partial-btn" onclick="delPartial('${rec.id}', '${p.id}')">âŒ</button></td></tr>`).join('')}<tr class="add-row"><td></td><td><input type="date" id="partial_date_out_${rec.id}" value="${today()}"></td><td><input type="number" id="partial_amount_${rec.id}" placeholder="ê¸ˆì•¡"></td><td><input type="number" id="partial_rate_out_${rec.id}" placeholder="í™˜ìœ¨"></td><td><input type="number" id="partial_fee_${rec.id}" placeholder="ìˆ˜ìˆ˜ë£Œ" value="0"></td><td><button class="add-partial-btn" onclick="addPartialExchange('${rec.id}')">ì¶”ê°€</button></td></tr></tbody></table></div><button class="btn-delete" onclick="delRow('${rec.id}')">ì´ ê¸°ë¡ ì‚­ì œí•˜ê¸°</button>`;
        }
      });
      const profitColor = totalNetProfit >= 0 ? 'var(--danger-color)' : 'var(--primary-color)';
      getEl('summary').innerHTML = `ì´ <b>${filteredRecords.length}</b>ê±´, ì™„ë£Œ ê±´ ìˆœì´ìµ í•©ê³„: <b style="color:${profitColor}">${numberFormat(totalNetProfit)}ì›</b>`;
    }

    function showTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-section button').forEach(b => {
            b.classList.remove('active');
            if(b.textContent.includes(tab) || (tab==='all' && b.textContent==='ì „ì²´')) {
                b.classList.add('active');
            }
        });
        renderTable();
    }
    
    function resetDateFilter(){ getEl('start-date').value = ''; getEl('end-date').value = ''; renderTable(); }

    // export, import í•¨ìˆ˜ëŠ” ê¸°ì¡´ ë¡œì§ ìœ ì§€ (Firestoreì™€ ì—°ë™ë˜ë„ë¡ ìˆ˜ì •)
    function exportData() {
        if(records.length === 0) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ì–´ìš”!");
        const dataStr = JSON.stringify(records, null, 2);
        const blob = new Blob([dataStr], {type:"application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        const dt = new Date(); a.download = `fx_diary_backup_${dt.getFullYear()}${String(dt.getMonth()+1).padStart(2,"0")}${String(dt.getDate()).padStart(2,"0")}.json`;
        a.click(); URL.revokeObjectURL(a.href);
    }
    function exportCSV() {
      //... (ê¸°ì¡´ exportCSV ë¡œì§ì€ ë³€ê²½ ì—†ìŒ)
      if(records.length === 0) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ì–´ìš”!");
      let csvContent = "í™˜ì „ë‚ ì§œ,ìµœì´ˆí™˜ì „ì•¡(ì›),ìµœì´ˆí™˜ìœ¨,ì´ììœ¨(%),ìƒíƒœ,ë¶€ë¶„í™˜ì „ì¼,ë¶€ë¶„í™˜ì „ì•¡(ì›),ë¶€ë¶„í™˜ì „í™˜ìœ¨,ê°œë³„ìˆ˜ìˆ˜ë£Œ(ì›)\n";
      records.forEach(rec => { const paidSum = (rec.partial_exchanges||[]).reduce((a,p)=>a+p.amount,0); const done = paidSum >= rec.money; const status = done ? "ì™„ë£Œ" : "ì§„í–‰ì¤‘"; if (rec.partial_exchanges.length === 0) { csvContent += `${rec.date_in},${rec.money},${rec.rate_in},${rec.interest},${status},,,, \n`; } else { rec.partial_exchanges.forEach(p => { csvContent += `${rec.date_in},${rec.money},${rec.rate_in},${rec.interest},${status},${p.date_out},${p.amount},${p.rate_out},${p.fee||0}\n`; }); } });
      const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      const dt = new Date(); a.download = `fx_diary_export_${dt.getFullYear()}${String(dt.getMonth()+1).padStart(2,"0")}${String(dt.getDate()).padStart(2,"0")}.csv`;
      a.click(); URL.revokeObjectURL(a.href);
    }
    async function importData(e) {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(evt) {
        try {
          const imported = JSON.parse(evt.target.result);
          if (Array.isArray(imported)) {
            if(!confirm("ê¸°ì¡´ ë°ì´í„°ê°€ ëª¨ë‘ ì‚¬ë¼ì§€ê³  ìƒˆë¡œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¡œ ë®ì–´ì”Œì›Œì ¸ìš”. ì •ë§ ì§„í–‰í• ê¹Œìš”?")) { e.target.value = ""; return; }
            records = imported;
            await saveToFirestore(); // Firestoreì— ì €ì¥
            showTab('all');
            alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
          } else { alert("ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤."); }
        } catch (err) { alert("ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: " + err.message); }
      }
      reader.readAsText(file); e.target.value = "";
    }

    // --- ğŸ‘‡ ë¡œê·¸ì¸ ê´€ë ¨ ìƒˆ í•¨ìˆ˜ë“¤ ---
    function openLoginModal() { getEl('login-modal').style.display = 'flex'; }
    function closeLoginModal() { getEl('login-modal').style.display = 'none'; getEl('modal-error').textContent = ''; }
    
    // --- í˜ì´ì§€ ë¡œë“œ ë° ë¡œê·¸ì¸ ìƒíƒœë³€í™” ê°ì§€ ---
    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn = getEl('login-btn');
      const logoutBtn = getEl('logout-btn');
      const userInfo = getEl('user-info');
      const userEmail = getEl('user-email');
      const appContent = getEl('app-content');

      const modalLoginBtn = getEl('modal-login-btn');
      const modalSignupBtn = getEl('modal-signup-btn');
      const modalEmailInput = getEl('modal-email');
      const modalPasswordInput = getEl('modal-password');
      const modalError = getEl('modal-error');
      
      // ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ (í•µì‹¬!)
      auth.onAuthStateChanged(async (user) => {
        if (user) { // ë¡œê·¸ì¸ ë˜ì—ˆì„ ë•Œ
          currentUser = user;
          loginBtn.style.display = 'none';
          userInfo.style.display = 'flex';
          userEmail.textContent = user.email;
          appContent.style.display = 'block';

          await loadFromFirestore(); // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
          getEl('date_in').value = today();
          renderTable();

        } else { // ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆì„ ë•Œ
          currentUser = null;
          loginBtn.style.display = 'block';
          userInfo.style.display = 'none';
          userEmail.textContent = '';
          appContent.style.display = 'none';
          records = []; // ë°ì´í„° ì´ˆê¸°í™”
          renderTable(); // ë¹ˆ í…Œì´ë¸” ê·¸ë¦¬ê¸°
        }
      });

      // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
      logoutBtn.addEventListener('click', () => auth.signOut());
      
      // ëª¨ë‹¬ì˜ ë¡œê·¸ì¸ ë²„íŠ¼
      modalLoginBtn.addEventListener('click', () => {
        const email = modalEmailInput.value;
        const password = modalPasswordInput.value;
        auth.signInWithEmailAndPassword(email, password)
          .then(() => closeLoginModal())
          .catch(error => modalError.textContent = error.message);
      });

      // ëª¨ë‹¬ì˜ íšŒì›ê°€ì… ë²„íŠ¼
      modalSignupBtn.addEventListener('click', () => {
        const email = modalEmailInput.value;
        const password = modalPasswordInput.value;
        auth.createUserWithEmailAndPassword(email, password)
          .then(() => {
             modalError.textContent = "íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
          })
          .catch(error => modalError.textContent = error.message);
      });
    });
</script>
</body>
</html>
