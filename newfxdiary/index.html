<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ÌôòÏ∞®Ïùµ Îã§Ïù¥Ïñ¥Î¶¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        /* CSS ÏùºÎ∂Ä ÏàòÏ†ï */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        :root {
          --primary-color: #3182F6;
          --background-color: #F2F4F6;
          --card-background-color: #FFFFFF;
          --text-color: #333D4B;
          --subtext-color: #8B95A1;
          --border-color: #E5E8EB;
          --success-color: #2E8B57;
          --danger-color: #D94242;
        }
        body { font-family: 'Noto Sans KR', 'Apple SD Gothic Neo', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 16px; font-size: 14px; -webkit-font-smoothing: antialiased; }
        .card { background-color: var(--card-background-color); border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); margin-bottom: 16px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 16px; flex-wrap: wrap; }
        h2 { font-size: 16px; font-weight: 700; margin: 0; color: var(--primary-color); flex-shrink: 0; }
        .tools { display: flex; gap: 8px; flex-shrink: 0; align-items: center; }
        .tools button, .tools label, .tools a { font-size: 13px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #F9FAFB; color: #4E5968; padding: 8px 12px; cursor: pointer; font-weight: 500; text-align: center; white-space: nowrap; text-decoration: none; display: inline-block; }
        .tools input[type="file"] { display: none; }
        .tools #login-btn-main { border-color: var(--primary-color); background-color: var(--primary-color); color: white; }
        .app-download-btn { background-color: var(--success-color) !important; border-color: var(--success-color) !important; color: white !important; font-weight: 700 !important; }
        .input-section { display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 8px; }
        .input-section input { flex: 1 1 auto; font-size: 14px; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #F9FAFB; min-width: 0; }
        .input-section input[type="date"] { flex-grow: 2; }
        .input-section input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(49, 130, 246, 0.2); }
        .input-section .submit-btn { flex-grow: 1; border: none; background-color: var(--primary-color); color: white; font-weight: 700; cursor: pointer; }
        .tab-section { display: flex; gap: 4px; background-color: #E9ECEF; border-radius: 8px; padding: 4px; }
        .tab-section button { flex: 1; padding: 8px 0; background-color: transparent; border: none; font-size: 14px; border-radius: 6px; color: var(--subtext-color); font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .tab-section button.active { background-color: var(--card-background-color); color: var(--primary-color); font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .date-filter { display:flex; gap: 6px; align-items: center; padding-top: 16px; }
        .date-filter input[type="date"] { flex: 1 1 auto; min-width: 90px; border:1px solid #d3d8dd; padding: 6px; border-radius: 6px; font-size: 13px;}
        .date-filter button { flex-shrink: 0; padding: 7px 10px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer; white-space: nowrap;}
        .date-filter .btn-search { background: var(--primary-color); color: white;}
        .date-filter .btn-reset { background: #E9ECEF; color:var(--subtext-color);}
        .summary { font-size: 15px; font-weight: 500; padding: 16px; background-color: #F0F6FF; color: #194583; border-radius: 12px; text-align: center; margin-top: 16px; }
        .table-container { width: 100%; overflow-x: auto; }
        .result-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); table-layout: fixed; }
        .result-table th, .result-table td { text-align: center; padding: 12px 4px; border-bottom: 1px solid var(--border-color); font-size: 12px; vertical-align: middle; }
        .result-table thead { background-color: #F9FAFB; }
        .result-table th { color: var(--subtext-color); font-weight: 500; padding: 10px 4px; }
        .result-table tr:last-child td { border-bottom: none; }
        .btn-sm { background: none; border: 1px solid var(--border-color); border-radius: 6px; padding: 4px 8px; font-size: 11px; cursor: pointer; min-width: 45px; white-space: nowrap; }
        .btn-detail { color: var(--primary-color); }
        .btn-delete { color: var(--danger-color); font-weight: 700; width: 100%; padding: 10px; margin-top: 10px; }
        .status { font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 16px; display: inline-block; white-space: nowrap; }
        .status-ing { background-color: #FFF8E5; color: #D97706; }
        .status-done { background-color: #E6F8EA; color: #14AD5E; }
        .profit-plus { color: var(--danger-color); }
        .profit-minus { color: var(--primary-color); }
        .profit-neutral { color: var(--subtext-color); }
        .details-content { display: none; background-color: #F9FAFB; padding: 16px; }
        .details-content.show { display: table-cell; }
        .detail-grid { display: grid; grid-template-columns: auto 1fr auto 1fr; gap: 8px 16px; align-items: center; font-size: 13px; }
        .detail-grid strong { color: var(--subtext-color); font-weight: 500; }
        .sub-table { margin-top: 16px; border-top: 1px solid var(--border-color); padding-top: 16px; }
        .sub-table table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .sub-table th, .sub-table td { text-align: center; padding: 8px 4px; border-bottom: 1px solid var(--border-color); }
        .sub-table th { background-color: #F3F4F6; font-weight: 500; }
        .sub-table input { width: 95%; box-sizing: border-box; text-align: center; border: 1px solid #D1D5DB; border-radius: 4px; padding: 4px; }
        .del-partial-btn { background: none; border: none; cursor: pointer; font-size: 16px; }
        .add-partial-btn { width: 100%; background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 6px; padding: 6px; cursor: pointer; font-weight: 500; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 380px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-content h3 { margin-top: 0; margin-bottom: 16px; text-align: center; font-size: 18px; }
        .modal-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; box-sizing: border-box; font-size: 15px; }
        .modal-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
        .modal-buttons button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; }
        #modal-login-btn, #logout-confirm-btn { background-color: var(--primary-color); color: white; }
        #modal-signup-btn { background-color: #E9ECEF; color: var(--subtext-color); }
        #modal-close-btn, #logout-cancel-btn { background-color: #E9ECEF; color: var(--subtext-color); }
        #logout-cancel-btn { margin-top: 10px;}
        #modal-error { font-size: 13px; text-align: center; margin-top: 16px; min-height: 18px; color: var(--danger-color); }
        #logout-modal-title { color: var(--text-color); font-size: 16px; text-align: center; margin: 16px 0; min-height: 18px; }
        .remember-me { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: var(--subtext-color); margin-bottom: 16px; }
        .remember-me div { display: flex; align-items: center; gap: 6px; }
        .remember-me label, .forgot-password a { cursor: pointer; text-decoration: none; color: var(--subtext-color); }
        .forgot-password a:hover { text-decoration: underline; }
        .terms-agreement { margin-top: 16px; padding: 10px; background-color: #F9FAFB; border: 1px solid var(--border-color); border-radius: 8px; font-size: 12px; color: var(--subtext-color); }
        .terms-agreement label { display: flex; align-items: flex-start; gap: 8px; cursor: pointer; }
        .terms-agreement input[type="checkbox"] { margin-top: 2px; flex-shrink: 0; }
        .terms-agreement strong { color: var(--text-color); font-weight: 500; display: block; margin-bottom: 4px; }
        #delete-account-modal-btn { background: none; color: var(--danger-color); font-weight: 500; padding: 10px; font-size: 14px; margin-top: 4px; border: 1px solid #FEE2E2; }
    </style>
</head>
<body>
<main id="app-content">
    <div class="wrap">
        <div class="card">
            <div class="header-row">
                <h2>ÌôòÏ∞®Ïùµ Îã§Ïù¥Ïñ¥Î¶¨ üí∏</h2>
                <div class="tools">
                    <a href="https://search.naver.com/search.naver?query=Îã¨Îü¨ÌôòÏú®" target="_blank" rel="noopener noreferrer">Ïã§ÏãúÍ∞Ñ ÌôòÏú®</a>
                    <a href="./fx_diary_app.apk" download class="app-download-btn">Ïï± Îã§Ïö¥Î°úÎìú</a>
                    <button onclick="exportData()">Î∞±ÏóÖ</button>
                    <label for="importFile">Î∂àÎü¨Ïò§Í∏∞</label>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                    <button id="login-btn-main" onclick="openLoginModal()">Î°úÍ∑∏Ïù∏</button>
                    <button id="logout-btn-main" style="display: none;">Î°úÍ∑∏ÏïÑÏõÉ</button>
                </div>
            </div>
            <div class="input-section">
                <div class="input-row">
                    <input type="number" id="money" placeholder="ÌôòÏ†ÑÍ∏àÏï°(Ïõê)" required>
                    <input type="number" id="rate_in" placeholder="ÌôòÏ†ÑÌôòÏú®" required step="any">
                    <input type="number" id="interest" placeholder="Ïù¥ÏûêÏú®(%)" step="any">
                </div>
                <div class="input-row">
                    <input type="date" id="date_in" title="ÌôòÏ†ÑÎÇ†Ïßú(ÏóÜÏúºÎ©¥ Ïò§Îäò)">
                    <button type="button" class="submit-btn" onclick="addRow()">Í∏∞Î°ù</button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="tab-section">
                <button onclick="showTab('all')" class="active" data-tab="all">Ï†ÑÏ≤¥</button>
                <button onclick="showTab('ing')" data-tab="ing">ÏßÑÌñâÏ§ë</button>
                <button onclick="showTab('done')" data-tab="done">ÏôÑÎ£å</button>
            </div>
            <div class="date-filter">
                <input type="date" id="start-date"><span>~</span><input type="date" id="end-date">
                <button onclick="renderTable()" class="btn-search">Ï°∞Ìöå</button>
                <button onclick="resetDateFilter()" class="btn-reset">Ï¥àÍ∏∞Ìôî</button>
            </div>
            <div class="summary" id="summary"></div>
        </div>
        <div class="table-container">
            <table class="result-table">
                <thead><tr><th>ÏÉÅÌÉú</th><th>ÌôòÏ†ÑÍ∏àÏï°</th><th>ÌôòÏ†ÑÎÇ†Ïßú</th><th>ÏàúÏù¥Ïùµ</th><th>ÏÉÅÏÑ∏</th></tr></thead>
                <tbody id="record-list"></tbody>
            </table>
        </div>
    </div>
</main>

<!-- Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
<div id="login-modal" class="modal-overlay">
    <div class="modal-content">
        <button id="modal-close-btn" onclick="closeLoginModal()">√ó</button>
        <h3>Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ</h3>
        <input class="modal-input" type="email" id="modal-email" placeholder="Ïù¥Î©îÏùº">
        <input class="modal-input" type="password" id="modal-password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ (6ÏûêÎ¶¨ Ïù¥ÏÉÅ)">
        <div class="remember-me">
            <div>
                <input type="checkbox" id="remember-me-checkbox">
                <label for="remember-me-checkbox">Ïù¥Î©îÏùº Í∏∞ÏñµÌïòÍ∏∞</label>
            </div>
            <div class="forgot-password">
                <a href="#" id="forgot-password-link">ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûäÏúºÏÖ®ÎÇòÏöî?</a>
            </div>
        </div>
        <div class="terms-agreement">
            <label for="terms-checkbox">
                <input type="checkbox" id="terms-checkbox">
                <div>
                    <strong>[ÌïÑÏàò] Í∞úÏù∏Ï†ïÎ≥¥ ÏàòÏßë Î∞è Ïù¥Ïö© ÎèôÏùò</strong>
                    <span>ÌöåÏõê ÏãùÎ≥Ñ Î∞è Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•ÏùÑ ÏúÑÌï¥ Ïù¥Î©îÏùº, ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏàòÏßëÌï©ÎãàÎã§.</span>
                </div>
            </label>
        </div>
        <div id="modal-error"></div>
        <div class="modal-buttons">
             <button id="modal-login-btn">Î°úÍ∑∏Ïù∏</button>
             <button id="modal-signup-btn">ÌöåÏõêÍ∞ÄÏûÖ</button>
        </div>
    </div>
</div>

<!-- Î°úÍ∑∏ÏïÑÏõÉ & ÌöåÏõêÌÉàÌá¥ ÌôïÏù∏ Î™®Îã¨ -->
<div id="logout-confirm-modal" class="modal-overlay">
    <div class="modal-content">
        <p id="logout-modal-title">Ïñ¥ÎñªÍ≤å Ìï†ÍπåÏöî?</p>
        <div class="modal-buttons">
            <button id="logout-confirm-btn">Î°úÍ∑∏ÏïÑÏõÉ</button>
            <button id="delete-account-modal-btn">ÌöåÏõêÌÉàÌá¥</button>
            <button id="logout-cancel-btn" onclick="closeLogoutModal()">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<footer style="text-align: center; padding: 30px 16px; font-size: 12px; color: #8B95A1; border-top: 1px solid #E5E8EB; margin-top: 20px;">
    <p>
        <a href="https://docs.google.com/document/d/1qAGPP5aBg5VDztATy5yu9hkUhsj7I8P7fR_4oqkdShs/edit?usp=sharing" target="_blank" style="color: inherit;">Ïù¥Ïö©ÏïΩÍ¥Ä</a> | 
        <a href="https://docs.google.com/document/d/1aWOY7yy0_Lq5hmMRgS7SDP1XwUe7u7y4lyN61_Kdxx4/edit?usp=sharing" target="_blank" style="color: inherit; font-weight: bold;">Í∞úÏù∏Ï†ïÎ≥¥Ï≤òÎ¶¨Î∞©Ïπ®</a>
    </p>
    <p style="margin-top: 8px;">Î¨∏Ïùò: parkgi1100@gmail.com</p>
    <p style="margin-top: 8px;">¬© 2024 ÌôòÏ∞®Ïùµ Îã§Ïù¥Ïñ¥Î¶¨. All Rights Reserved.</p>
</footer>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBw7_3CquES3aoDpgrIAo8iJWouO68xm3o",
      authDomain: "fxdiarynew.firebaseapp.com",
      projectId: "fxdiarynew",
      storageBucket: "fxdiarynew.appspot.com",
      messagingSenderId: "924905093472",
      appId: "1:924905093472:web:62ce7aa52161730bd58605",
      measurementId: "G-2HDGLJSLS8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const LOCAL_STORAGE_KEY = 'fx_records_guest';
    const REMEMBER_EMAIL_KEY = 'fx_diary_remembered_email';
    let records = [];
    let currentTab = 'all';
    let currentUser = null;

    const getEl = (id) => document.getElementById(id);
    function today() { return new Date().toISOString().slice(0, 10); }
    function numberFormat(n) { return Math.round(n).toLocaleString('ko-KR'); }

    function saveLocalData() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(records)); }
    function loadLocalData() { const data = localStorage.getItem(LOCAL_STORAGE_KEY); records = data ? JSON.parse(data) : []; }
    async function saveToFirestore() { if (!currentUser) return; records.forEach((r, i) => { if (!r.id) r.id = `record_${Date.now()}_${i}`; }); try { await db.collection('diaries').doc(currentUser.uid).set({ records: records }); } catch (error) { console.error("Firestore Ï†ÄÏû• Ïò§Î•ò: ", error); } }
    async function loadFromFirestore() { if (!currentUser) return; try { const doc = await db.collection('diaries').doc(currentUser.uid).get(); records = (doc.exists && doc.data().records) ? doc.data().records : []; } catch (error) { console.error("Firestore Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò: ", error); records = []; } }
    async function saveData() { if (currentUser) { await saveToFirestore(); } else { saveLocalData(); } }
    
    function exportData() {
        if (records.length === 0) return alert("ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥Ïöî!");
        const dataStr = JSON.stringify(records, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const dt = new Date();
        a.download = `fx_diary_backup_${dt.getFullYear()}${String(dt.getMonth() + 1).padStart(2, "0")}${String(dt.getDate()).padStart(2, "0")}.json`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }
    async function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (Array.isArray(imported)) {
                    if (!confirm("Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Í∞Ä Î™®Îëê ÏÇ¨ÎùºÏßÄÍ≥† ÏÉàÎ°ú Î∂àÎü¨Ïò® Îç∞Ïù¥ÌÑ∞Î°ú ÎçÆÏñ¥ÏîåÏõåÏ†∏Ïöî. Ï†ïÎßê ÏßÑÌñâÌï†ÍπåÏöî?")) {
                        event.target.value = ""; 
                        return;
                    }
                    records = imported;
                    await saveData();
                    showTab('all');
                    alert("Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å!");
                } else {
                    alert("ÏûòÎ™ªÎêú ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§.");
                }
            } catch (err) {
                alert("ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + err.message);
            }
        };
        reader.readAsText(file);
        event.target.value = ""; 
    }

    async function addRow() { if (getEl('money').value === '' || getEl('rate_in').value === '') return alert("ÌôòÏ†ÑÍ∏àÏï°Í≥º ÌôòÏ†ÑÌôòÏú®ÏùÑ Ï±ÑÏõåÏ£ºÏÑ∏Ïöî!"); records.unshift({ money: Number(getEl('money').value), rate_in: Number(getEl('rate_in').value), interest: Number(getEl('interest').value) || 0, date_in: getEl('date_in').value || today(), id: 'record_' + Date.now(), isDetailVisible: false, partial_exchanges: [] }); await saveData(); renderTable(); getEl('money').value = ''; getEl('rate_in').value = ''; getEl('interest').value = ''; getEl('date_in').value = today(); }
    async function delRow(recordId) { if (confirm("Ï†ïÎßê Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†Ïñ¥Ïöî?")) { records = records.filter(r => r.id !== recordId); await saveData(); renderTable(); } }
    async function addPartialExchange(recordId) { const rec = records.find(r => r.id === recordId); if (!rec) return; const amount = Number(getEl(`partial_amount_${rec.id}`).value), rate_out = Number(getEl(`partial_rate_out_${rec.id}`).value); if (!amount || !rate_out) return alert("Í∏àÏï°/ÌôòÏú® ÏûÖÎ†•ÌïòÏÑ∏Ïöî!"); if (rec.partial_exchanges.reduce((s, p) => s + p.amount, 0) + amount > rec.money + 1) return alert("Ï†ÑÏ≤¥ ÌôòÏ†ÑÍ∏àÏï° Ï¥àÍ≥º!"); rec.partial_exchanges.push({ amount, rate_out, date_out: getEl(`partial_date_out_${rec.id}`).value || today(), fee: Number(getEl(`partial_fee_${rec.id}`).value) || 0, id: 'p_' + Date.now() }); rec.partial_exchanges.sort((a, b) => new Date(a.date_out) - new Date(b.date_out)); await saveData(); renderTable(); }
    async function delPartial(recordId, partialId) { const rec = records.find(r => r.id === recordId); if (rec) { rec.partial_exchanges = rec.partial_exchanges.filter(p => p.id !== partialId); await saveData(); renderTable(); } }
    async function updatePartialFee(recordId, partialId, newFee) { const rec = records.find(r => r.id === recordId); if (rec) { const p = rec.partial_exchanges.find(p => p.id === partialId); if (p) p.fee = Number(newFee); await saveData(); renderTable(); } }
    
    function toggleDetail(recordId) { const record = records.find(r => r.id === recordId); if (record) { record.isDetailVisible = !record.isDetailVisible; renderTable(); } }
    function renderTable() { let baseRecords=[...records]; baseRecords.sort((a,b)=>new Date(b.date_in)-new Date(a.date_in)); let filteredRecords=baseRecords; if(currentTab==='ing'){filteredRecords=baseRecords.filter(r=>r.partial_exchanges.reduce((a,p)=>a+p.amount,0)<r.money);}else if(currentTab==='done'){filteredRecords=baseRecords.filter(r=>r.partial_exchanges.reduce((a,p)=>a+p.amount,0)>=r.money);} const startDateVal=getEl('start-date').value; const endDateVal=getEl('end-date').value; if(startDateVal&&endDateVal){const start=new Date(startDateVal); const end=new Date(endDateVal); end.setHours(23,59,59,999); filteredRecords=filteredRecords.filter(r=>{const d=new Date(r.date_in); return d>=start&&d<=end;});} const recordList=getEl('record-list'); recordList.innerHTML=""; let totalNetProfit=0; if(filteredRecords.length===0){recordList.innerHTML="<tr><td colspan='5' style='text-align:center; color: #8B95A1; padding: 40px;'>Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</td></tr>";} filteredRecords.forEach(rec=>{const paidSum=rec.partial_exchanges.reduce((a,p)=>a+p.amount,0); const isDone=paidSum>=rec.money; let fx_profit_total=0; rec.partial_exchanges.forEach(p=>{if(p.rate_out>0)fx_profit_total+=(p.amount-(p.amount/p.rate_out*rec.rate_in));}); const total_fee=rec.partial_exchanges.reduce((s,p)=>s+(p.fee||0),0); let d1=new Date(rec.date_in); let d2=rec.partial_exchanges.length?new Date(rec.partial_exchanges[rec.partial_exchanges.length-1].date_out):new Date(); const days=isDone?Math.max(0,Math.round((d2-d1)/(1000*60*60*24))):'-'; const int_fee=isDone?(rec.money*rec.interest/100*days/365):0; const net_profit=fx_profit_total-int_fee-total_fee; if(isDone)totalNetProfit+=net_profit; const profitClass=!isDone?'profit-neutral':(net_profit>=0?'profit-plus':'profit-minus'); const row=recordList.insertRow(); row.innerHTML=`<td><span class="status ${isDone?'status-done':'status-ing'}">${isDone?'ÏôÑÎ£å':'ÏßÑÌñâÏ§ë'}</span></td><td>${numberFormat(rec.money)}Ïõê</td><td>${rec.date_in.substring(5)}</td><td><b class="${profitClass}">${isDone?(net_profit>=0?'+':'')+numberFormat(net_profit)+'Ïõê':'-'}</b></td><td><button class="btn-sm btn-detail" onclick="toggleDetail('${rec.id}')">${rec.isDetailVisible?'‚ñ≤ Îã´Í∏∞':'‚ñº ÏÉÅÏÑ∏'}</button></td>`; if(rec.isDetailVisible){const detailRow=recordList.insertRow(); detailRow.insertCell().colSpan=5; detailRow.cells[0].className='details-content show'; detailRow.cells[0].innerHTML=`<div class="detail-grid"><strong>ÌôòÏ†ÑÌôòÏú®</strong><span>${rec.rate_in}</span><strong>ÌôòÏ†ÑÍ∏àÏï°($)</strong><span>${(rec.money/rec.rate_in).toFixed(2)}$</span><strong>Ïù¥ÏûêÏú®</strong><span>${rec.interest}%</span><strong>Í≤ΩÍ≥ºÏùºÏàò</strong><span>${days}Ïùº</span><strong>Ïù¥ÏûêÎπÑÏö©</strong><span>${numberFormat(int_fee)}Ïõê</span><strong>ÏàòÏàòÎ£åÌï©Í≥Ñ</strong><span>${numberFormat(total_fee)}Ïõê</span></div><div class="sub-table"><table><thead><tr><th>#</th><th>ÎÇ†Ïßú</th><th>Í∏àÏï°</th><th>ÌôòÏú®</th><th>ÏàòÏàòÎ£å</th><th>ÏÇ≠Ï†ú</th></tr></thead><tbody>${rec.partial_exchanges.map((p,idx)=>`<tr><td>${idx+1}</td><td>${p.date_out}</td><td>${numberFormat(p.amount)}</td><td>${p.rate_out}</td><td><input type="number" value="${p.fee||0}" onchange="updatePartialFee('${rec.id}','${p.id}',this.value)"></td><td><button class="del-partial-btn" onclick="delPartial('${rec.id}','${p.id}')">‚ùå</button></td></tr>`).join('')}<tr class="add-row"><td></td><td><input type="date" id="partial_date_out_${rec.id}" value="${today()}"></td><td><input type="number" id="partial_amount_${rec.id}" placeholder="Í∏àÏï°"></td><td><input type="number" id="partial_rate_out_${rec.id}" placeholder="ÌôòÏú®"></td><td><input type="number" id="partial_fee_${rec.id}" placeholder="ÏàòÏàòÎ£å" value="0"></td><td><button class="add-partial-btn" onclick="addPartialExchange('${rec.id}')">Ï∂îÍ∞Ä</button></td></tr></tbody></table></div><button class="btn-delete" onclick="delRow('${rec.id}')">Ïù¥ Í∏∞Î°ù ÏÇ≠Ï†úÌïòÍ∏∞</button>`;}}); const profitColor=totalNetProfit>=0?'var(--danger-color)':'var(--primary-color)'; getEl('summary').innerHTML=`Ï¥ù <b>${filteredRecords.length}</b>Í±¥, ÏôÑÎ£å Í±¥ ÏàúÏù¥Ïùµ Ìï©Í≥Ñ: <b style="color:${profitColor}">${numberFormat(totalNetProfit)}Ïõê</b>`; }
    function showTab(tab) { currentTab = tab; document.querySelectorAll('.tab-section button').forEach(btn => { btn.classList.remove('active'); }); const clickedButton = document.querySelector(`.tab-section button[data-tab="${tab}"]`); if (clickedButton) { clickedButton.classList.add('active'); } renderTable(); }
    function resetDateFilter(){ getEl('start-date').value = ''; getEl('end-date').value = ''; renderTable(); }

    function openLoginModal() { const rememberedEmail = localStorage.getItem(REMEMBER_EMAIL_KEY); if (rememberedEmail) { getEl('modal-email').value = rememberedEmail; getEl('remember-me-checkbox').checked = true; } getEl('login-modal').style.display = 'flex'; }
    function closeLoginModal() { getEl('login-modal').style.display = 'none'; getEl('modal-error').textContent = ''; getEl('modal-error').style.color = 'var(--danger-color)'; }
    function openLogoutModal() { getEl('logout-confirm-modal').style.display = 'flex'; }
    function closeLogoutModal() { getEl('logout-confirm-modal').style.display = 'none'; }
    
    async function deleteAccount() {
        if (!currentUser) return;
        const confirmation = confirm("Ï†ïÎßêÎ°ú Í≥ÑÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÎ™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÎ©∞, Îã§ÏãúÎäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
        if (!confirmation) return;
        try {
            await db.collection('diaries').doc(currentUser.uid).delete();
            await currentUser.delete();
            alert("Í≥ÑÏ†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
            closeLogoutModal();
        } catch (error) {
            console.error("Í≥ÑÏ†ï ÏÇ≠Ï†ú Ïò§Î•ò:", error);
            if (error.code === 'auth/requires-recent-login') {
                alert("Î≥¥ÏïàÏùÑ ÏúÑÌï¥ Îã§Ïãú Î°úÍ∑∏Ïù∏Ìïú ÌõÑ Í≥ÑÏ†ï ÏÇ≠Ï†úÎ•º ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
            } else {
                alert("Í≥ÑÏ†ï ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
            }
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const loginBtn = getEl('login-btn-main');
        const logoutBtn = getEl('logout-btn-main');
        const modalLoginBtn = getEl('modal-login-btn');
        const modalSignupBtn = getEl('modal-signup-btn');
        const logoutConfirmBtn = getEl('logout-confirm-btn');
        const deleteAccountModalBtn = getEl('delete-account-modal-btn');
        const forgotPasswordLink = getEl('forgot-password-link');

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                await loadFromFirestore();
                renderTable();
            } else {
                currentUser = null;
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                loadLocalData();
                renderTable();
            }
        });

        logoutBtn.addEventListener('click', openLogoutModal);
        logoutConfirmBtn.addEventListener('click', () => { auth.signOut(); closeLogoutModal(); });
        deleteAccountModalBtn.addEventListener('click', deleteAccount);
      
        forgotPasswordLink.addEventListener('click', (event) => {
            event.preventDefault();
            const email = getEl('modal-email').value;
            const modalError = getEl('modal-error');

            if (!email) {
                modalError.textContent = "ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Ï∞æÏúºÎ†§Î©¥ Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
                return;
            }

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    modalError.textContent = "ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï Ïù¥Î©îÏùºÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§. Î∞õÏùÄÌé∏ÏßÄÌï®ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.";
                    modalError.style.color = 'var(--success-color)';
                })
                .catch((error) => {
                    modalError.style.color = 'var(--danger-color)';
                    if (error.code === 'auth/user-not-found') {
                        modalError.textContent = "Í∞ÄÏûÖÎêòÏßÄ ÏïäÏùÄ Ïù¥Î©îÏùºÏûÖÎãàÎã§.";
                    } else {
                        modalError.textContent = "Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.";
                    }
                });
        });

        modalLoginBtn.addEventListener('click', () => {
            const email = getEl('modal-email').value; const password = getEl('modal-password').value;
            const rememberMe = getEl('remember-me-checkbox').checked;
            const modalError = getEl('modal-error');
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    if (rememberMe) { localStorage.setItem(REMEMBER_EMAIL_KEY, email); } 
                    else { localStorage.removeItem(REMEMBER_EMAIL_KEY); }
                    closeLoginModal();
                })
                .catch(error => {
                    modalError.style.color = 'var(--danger-color)';
                    console.error("Login Error:", error.code);
                    switch (error.code) {
                        case 'auth/user-not-found':
                        case 'auth/invalid-credential':
                        case 'auth/wrong-password':
                            modalError.textContent = "Ïù¥Î©îÏùº ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.";
                            break;
                        case 'auth/invalid-email':
                            modalError.textContent = "Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.";
                            break;
                        default:
                            modalError.textContent = "Î°úÍ∑∏Ïù∏ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
                            break;
                    }
                });
        });

        modalSignupBtn.addEventListener('click', () => {
            const modalError = getEl('modal-error');
            if (!getEl('terms-checkbox').checked) {
                modalError.textContent = "Í∞úÏù∏Ï†ïÎ≥¥ ÏàòÏßë Î∞è Ïù¥Ïö© ÏïΩÍ¥ÄÏóê ÎèôÏùòÌï¥Ï£ºÏÑ∏Ïöî.";
                return;
            }
            const email = getEl('modal-email').value, password = getEl('modal-password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    modalError.style.color = 'var(--success-color)';
                    modalError.textContent = "ÌöåÏõêÍ∞ÄÏûÖ ÏÑ±Í≥µ! Ïù¥Ï†ú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.";
                })
                .catch(error => {
                    modalError.style.color = 'var(--danger-color)';
                    console.error("Signup Error:", error.code);
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            modalError.textContent = "Ïù¥ÎØ∏ Í∞ÄÏûÖÎêú Ïù¥Î©îÏùºÏûÖÎãàÎã§. Î°úÍ∑∏Ïù∏ÏùÑ ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.";
                            break;
                        case 'auth/weak-password':
                            modalError.textContent = "ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 6ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.";
                            break;
                        case 'auth/invalid-email':
                            modalError.textContent = "Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.";
                            break;
                        default:
                            modalError.textContent = "ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
                            break;
                    }
                });
        });
    });
</script>
</body>
</html>
